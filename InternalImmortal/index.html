<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endless RPG Final</title>
    <style>
        body { background-color: #12121a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        #game-container { position: relative; width: 450px; height: 800px; background: #0c0c14; border: 2px solid #444; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5); overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-canvas { z-index: 15; pointer-events: none; }

        .ui-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(18, 18, 26, 0.9); backdrop-filter: blur(5px); transition: opacity 0.5s ease; z-index: 10; padding-top: 80px; box-sizing: border-box; }
        .hidden { opacity: 0; pointer-events: none; }
        
        #player-screen { justify-content: flex-start; overflow-y: auto; padding-bottom: 50px; }
        #player-screen::-webkit-scrollbar { display: none; }
        #player-screen { -ms-overflow-style: none; scrollbar-width: none; }

        .button { padding: 15px 30px; font-size: 24px; font-weight: bold; color: #fff; background: linear-gradient(45deg, #5f72be, #3c4a8a); border: 2px solid #8a9ce2; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(95, 114, 190, 0.4); margin: 10px; }
        .button:hover { transform: translateY(-3px) scale(1.05); }
        .button:active { transform: translateY(1px) scale(0.98); }
        .button.disabled { background: #555; border-color: #777; cursor: not-allowed; box-shadow: none; transform: none; }
        .button.small { padding: 10px 20px; font-size: 18px; }
        .button.danger { background: linear-gradient(45deg, #e63946, #a11d2b); border-color: #f08080; }

        h1, h2, p { text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        h1 { font-size: 48px; margin-bottom: 20px; }
        h2 { font-size: 32px; color: #a2b0f0; }
        p.subtitle { font-size: 18px; color: #ccc; margin-top: -15px; margin-bottom: 30px; }

        .shop-item { display: flex; justify-content: space-between; align-items: center; width: 85%; background: rgba(0,0,0,0.2); border: 1px solid #444; border-radius: 8px; padding: 15px; margin: 8px 0; }
        .shop-item-info { text-align: left; }
        .shop-item-info h3 { margin: 0; font-size: 20px; }
        .shop-item-info p { margin: 5px 0 0; font-size: 14px; color: #aaa; text-align: left; }
        .cost-text { color: #ffd700; }
        .gold-display { position: absolute; top: 20px; right: 20px; font-size: 24px; font-weight: bold; color: #ffd700; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; }
        
        #game-over-screen h2 { color: #e63946; }
        .stats-container, .skills-container { width: 85%; }
        .skills-container h2 { font-size: 24px; margin-top: 10px; margin-bottom: 10px; }
        .stat-block, .skill-block { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .stat-header, .skill-header { display: flex; justify-content: space-between; align-items: baseline; }
        .stat-header h3, .skill-header h3 { margin: 0; font-size: 18px; color: #a2b0f0; }
        .stat-header span, .skill-header span { font-size: 14px; color: #aaa; }
        .stat-value { font-size: 22px; color: #fff; margin: 5px 0; }
        .progress-bar-container { width: 100%; height: 8px; background-color: #333; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .progress-bar-fill.health { background-color: #c1121f; }
        .progress-bar-fill.attack { background-color: #f77f00; }
        .progress-bar-fill.rage { background-color: #7209b7; }
        .progress-bar-fill.regen { background-color: #4caf50; }
        .progress-bar-fill.skill { background-color: #00b4d8; }
        .skill-block p { font-size: 14px; color: #ccc; text-align: left; margin: 5px 0 0; }
        .skill-block.locked { opacity: 0.5; }
        .skill-block.locked h3 { color: #aaa; }
        #player-screen h3.level-up { animation: level-up-flash 1s ease; }
        @keyframes level-up-flash { 0%, 100% { color: #a2b0f0; transform: scale(1); } 50% { color: #ffd700; transform: scale(1.1); } }

        .battle-banner { position: absolute; top: 40%; left: 50%; transform: translateX(-50%); font-size: 48px; font-weight: bold; color: #fff; padding: 10px 30px; border-radius: 10px; z-index: 20; pointer-events: none; opacity: 0; }
        .stage-clear-banner { background: linear-gradient(90deg, #4CAF50, #2E7D32); text-shadow: 0 0 10px #fff; animation: ultimate-flash 2.5s ease-out forwards; }
        .ultimate-banner { background: linear-gradient(90deg, #f72585, #7209b7); text-shadow: 0 0 10px #fff; animation: ultimate-flash 1.5s ease-out forwards; }
        @keyframes ultimate-flash { 0% { transform: translateX(-50%) scale(0.5); opacity: 0; } 50% { transform: translateX(-50%) scale(1.1); opacity: 1; } 80% { transform: translateX(-50%) scale(1); opacity: 1; } 100% { transform: translateX(-50%) scale(1); opacity: 0; } }
        
        .combat-button { position: absolute; padding: 10px; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; flex-direction: column; line-height: 1; font-size: 20px; z-index: 5; }
        #ult-button { left: 10px; bottom: 10px; background: #5a1835; border-color: #f72585; }
        #auto-battle-button { right: 10px; bottom: 10px; background: #555; border-color: #888; }
        #auto-battle-button.active { background: linear-gradient(45deg, #4CAF50, #2E7D32); border-color: #81C784; }
        
        #ult-button.is-flashing { animation: flash-effect 0.8s infinite; border: 2px solid #ffd700; }
        @keyframes flash-effect { 0%, 100% { filter: brightness(1); box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4); } 50% { filter: brightness(1.8); box-shadow: 0 6px 30px rgba(247, 37, 133, 0.9); } }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <canvas id="ui-canvas"></canvas>
        <div id="main-menu-screen" class="ui-panel">
            <h1>Endless Shapes</h1><p class="subtitle">An Idle RPG Adventure</p>
            <div id="start-game-button" class="button">Begin</div>
            <div id="reset-save-button" class="button small danger">Reset Save</div>
        </div>
        <div id="shop-screen" class="ui-panel hidden">
            <h1>Stage <span id="stage-number">1</span> Cleared!</h1><p class="subtitle">Spend Gold to grow stronger.</p><div class="gold-display">ðŸ’° <span id="gold-total">0</span></div>
            <div class="shop-item"><div class="shop-item-info"><h3>Attack Power</h3><p>Current: <span id="attack-power-stat">10</span></p></div><div class="button" id="upgrade-attack-button">Upgrade (<span class="cost-text" id="attack-cost">10</span>)</div></div>
            <div class="shop-item"><div class="shop-item-info"><h3>Max Health</h3><p>Current: <span id="max-health-stat">100</span></p></div><div class="button" id="upgrade-health-button">Upgrade (<span class="cost-text" id="health-cost">10</span>)</div></div>
            <div class="shop-item"><div class="shop-item-info"><h3>Rage Gain</h3><p>Current: <span id="rage-gain-stat">5</span></p></div><div class="button" id="upgrade-rage-button">Upgrade (<span class="cost-text" id="rage-cost">20</span>)</div></div>
            <div class="shop-item"><div class="shop-item-info"><h3>Health Regen</h3><p>Current: <span id="health-regen-stat">0</span>/s</p></div><div class="button" id="upgrade-regen-button">Upgrade (<span class="cost-text" id="regen-cost">30</span>)</div></div>
            <div style="display: flex; justify-content: center; width: 100%; margin-top: 20px;">
                <div id="player-stats-button" class="button small">Player Stats</div>
                <div id="next-level-button" class="button" style="margin: 10px; background: linear-gradient(45deg, #4CAF50, #2E7D32);">Next Stage</div>
            </div>
        </div>
        <div id="game-over-screen" class="ui-panel hidden">
            <h1>Defeated!</h1><h2>You reached Stage <span id="final-stage-reached">1</span></h2><div id="retry-button" class="button">Try Again</div>
        </div>
        <div id="player-screen" class="ui-panel hidden">
            <h1>SoulCraft</h1>
            <div class="stats-container"></div>
            <div class="skills-container"></div>
            <div id="player-screen-back-button" class="button small">Back to Shop</div>
        </div>
        <div id="battle-event-banner" class="battle-banner"></div>
        <div id="ult-button" class="button combat-button hidden">RAGE</div>
        <div id="auto-battle-button" class="button combat-button hidden">AUTO</div>
    </div>

    <script>
    const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d');
    const uiCanvas = document.getElementById('ui-canvas'), uiCtx = uiCanvas.getContext('2d');
    canvas.width = uiCanvas.width = 450;
    canvas.height = uiCanvas.height = 800;
    const SAVE_KEY = 'endlessShapesSaveData';

    // --- DOM REFERENCES ---
    const dom = {mainMenu:document.getElementById('main-menu-screen'),shop:document.getElementById('shop-screen'),gameOver:document.getElementById('game-over-screen'),playerStats:document.getElementById('player-screen'),startBtn:document.getElementById('start-game-button'),nextBtn:document.getElementById('next-level-button'),retryBtn:document.getElementById('retry-button'),resetBtn:document.getElementById('reset-save-button'),statsBtn:document.getElementById('player-stats-button'),backBtn:document.getElementById('player-screen-back-button'),battleBanner:document.getElementById('battle-event-banner'),goldDisplay:document.getElementById('gold-total'),stageDisplay:document.getElementById('stage-number'),upgradeBtns:{attack:document.getElementById('upgrade-attack-button'),health:document.getElementById('upgrade-health-button'),rage:document.getElementById('upgrade-rage-button'),regen:document.getElementById('upgrade-regen-button')},ultBtn:document.getElementById('ult-button'),autoBtn:document.getElementById('auto-battle-button')};

    // --- GAME STATE & DATA ---
    let gameState, currentStage, player, enemies, particles, floatingTexts, projectiles, healthOrbs, shakeDuration, isAutoBattle, endCombatTimer, uiParticles, skillVisuals=[];
    const SKILLS_DATA={orbitalStrike:{name:"Orbital Strike",unlockStage:10,baseCooldown:300,cooldownReductionPerLevel:2,baseDamageMultiplier:.5,damageMultiplierPerLevel:.05,baseTargetXP:10},chainLightning:{name:"Chain Lightning",unlockStage:25,baseCooldown:240,cooldownReductionPerLevel:1.5,baseDamageMultiplier:.3,damageMultiplierPerLevel:.03,baseJumps:2,jumpsPerLevel:5,baseTargetXP:15},meteorShower:{name:"Meteor Shower",unlockStage:50,baseCooldown:400,cooldownReductionPerLevel:3,baseDamageMultiplier:.8,damageMultiplierPerLevel:.1,baseCount:5,countPerLevel:10,baseTargetXP:20}};

    // --- INITIALIZATION & SAVE/LOAD ---
    function createStat(c){return{name:c.name,level:c.level||1,current:c.current||0,target:c.target||100,baseGain:c.baseGain||1,displaySuffix:c.displaySuffix||'',isFloat:c.isFloat||!1,color:c.color}}
    function initGame(fromScratch=false){gameState='MAIN_MENU';currentStage=1;player={hp:100,rage:0,gold:0,stats:{maxHp:createStat({name:"Max Health",current:100,target:500,baseGain:20,color:'health'}),attackPower:createStat({name:"Attack Power",current:10,target:100,baseGain:2,color:'attack'}),rageGain:createStat({name:"Rage Gain",current:5,target:50,baseGain:1,color:'rage'}),healthRegen:createStat({name:"Health Regen",current:0,target:10,baseGain:.5,isFloat:!0,displaySuffix:'/s',color:'regen'})},costs:{maxHp:10,attackPower:10,rageGain:20,healthRegen:30},skills:{},x:canvas.width/2,y:canvas.height-150,size:40,color:"#61a5c2",isAttacking:!1,attackAnimTimer:0,baseY:canvas.height-150,sword:{angle:0,length:30}};Object.keys(SKILLS_DATA).forEach(id=>{player.skills[id]={isUnlocked:!1,cooldownTimer:0,level:1,currentXP:0,targetXP:SKILLS_DATA[id].baseTargetXP}});isAutoBattle=!1;endCombatTimer=0;enemies=[];particles=[];floatingTexts=[];projectiles=[];healthOrbs=[];shakeDuration=0;uiParticles=[];if(!fromScratch)loadGame();player.hp=player.stats.maxHp.current;const stars=[];for(let i=0;i<100;i++)stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,radius:Math.random()*1.5,speed:.2+Math.random()*.5});window.stars=stars}
    function saveGame(){try{localStorage.setItem(SAVE_KEY,JSON.stringify({player,currentStage,isAutoBattle}))}catch(e){console.error("Could not save game:",e)}}
    function loadGame(){try{const savedData=localStorage.getItem(SAVE_KEY);if(!savedData)return;const loaded=JSON.parse(savedData);if(typeof loaded.player.stats.maxHp==="number"||!loaded.player.skills.orbitalStrike.level){console.log("Old save detected, migrating...");const isV1=!loaded.player.stats.maxHp.level;const migratedPlayer={...loaded.player};if(isV1){migratedPlayer.stats.maxHp=createStat({name:"Max Health",current:loaded.player.stats.maxHp,target:500,baseGain:20,color:'health'});migratedPlayer.stats.attackPower=createStat({name:"Attack Power",current:loaded.player.stats.attackPower,target:100,baseGain:2,color:'attack'});migratedPlayer.stats.rageGain=createStat({name:"Rage Gain",current:loaded.player.stats.rageGain,target:50,baseGain:1,color:'rage'});migratedPlayer.stats.healthRegen=createStat({name:"Health Regen",current:loaded.player.stats.healthRegen,target:10,baseGain:.5,isFloat:!0,displaySuffix:'/s',color:'regen'});}Object.keys(SKILLS_DATA).forEach(id=>{const oldSkill=loaded.player.skills[id];migratedPlayer.skills[id]={isUnlocked:oldSkill?oldSkill.isUnlocked:!1,cooldownTimer:0,level:1,currentXP:0,targetXP:SKILLS_DATA[id].baseTargetXP}});player=migratedPlayer}else{player=loaded.player}currentStage=loaded.currentStage;isAutoBattle=loaded.isAutoBattle}catch(e){console.error("Could not load save data, starting fresh.",e)}}
    function resetGame(){if(confirm("Are you sure you want to reset all progress? This cannot be undone.")){localStorage.removeItem(SAVE_KEY);initGame(!0);location.reload()}}

    // --- AUDIO & VISUALS ---
    const audioCtx=new(window.AudioContext||window.webkitAudioContext);function playSound(f,t,d,v=.5){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g),g.connect(audioCtx.destination),o.type=t,o.frequency.setValueAtTime(f,audioCtx.currentTime),g.gain.setValueAtTime(v,audioCtx.currentTime),g.gain.exponentialRampToValueAtTime(1e-4,audioCtx.currentTime+d),o.start(),o.stop(audioCtx.currentTime+d)}
    const SOUNDS={click:()=>playSound(440,"sine",.1,.3),playerAttack:()=>playSound(200,"square",.1,.2),enemyAttack:()=>playSound(150,"sawtooth",.1,.2),hit:()=>playSound(880,"triangle",.15,.5),enemyDeath:()=>playSound(100,"sawtooth",.4,.4),ultimate:()=>playSound(80,"sawtooth",.8,.7),upgrade:()=>playSound(600,"triangle",.2,.4),gameOver:()=>playSound(150,"sawtooth",.8,.5),stageClear:()=>playSound(783,"sine",.5),heal:()=>playSound(523,"triangle",.2,.4),levelUp:()=>playSound(900,"sawtooth",.3,.5)};
    function createExplosion(x,y,c,co,s=3,sp=5){const colors=["#fff","#ffd700","#ff8c00",co];for(let i=0;i<c;i++)particles.push({x,y,vx:(Math.random()-.5)*sp,vy:(Math.random()-.5)*sp,life:Math.random()*30+20,color:colors[Math.floor(Math.random()*colors.length)],size:Math.random()*s+1})}
    function addFloatingText(t,x,y,c){floatingTexts.push({text:t,x,y,life:60,color:c})}
    function triggerScreenShake(d){shakeDuration=d}
    function showBattleBanner(t,ty,d){dom.battleBanner.textContent=t;dom.battleBanner.className=`battle-banner ${ty}`;setTimeout(()=>{dom.battleBanner.className='battle-banner hidden'},d)}
    
    // --- CORE FLOW & UI ---
    function changeState(newState){Object.values(dom).forEach(el=>{if(el.classList&&el.classList.contains('ui-panel'))el.classList.add('hidden')});dom.ultBtn.classList.add('hidden');dom.autoBtn.classList.add('hidden');uiParticles=[];gameState=newState;if(newState!=='COMBAT'&&newState!=='ENDING_COMBAT')SOUNDS.click();switch(newState){case'MAIN_MENU':dom.mainMenu.classList.remove('hidden');break;case'COMBAT':setupNextStage();dom.ultBtn.classList.remove('hidden');dom.autoBtn.classList.remove('hidden');break;case'SHOP':saveGame();checkSkillUnlocks();dom.shop.classList.remove('hidden');updateShopUI();setTimeout(createShopParticles,100);break;case'GAME_OVER':dom.gameOver.classList.remove('hidden');document.getElementById('final-stage-reached').textContent=currentStage;break;case'PLAYER_STATS':dom.playerStats.classList.remove('hidden');updatePlayerScreenUI();setTimeout(createStatsScreenParticles,100);break;case'ENDING_COMBAT':player.isAttacking=!1;endCombatTimer=120;showBattleBanner('Stage Cleared!','stage-clear-banner',2500);SOUNDS.stageClear();break;}}
    function createShopParticles(){const gameContainerRect=document.getElementById('game-container').getBoundingClientRect();document.querySelectorAll('#shop-screen .button, .gold-display, #shop-screen h1').forEach(el=>{const rect=el.getBoundingClientRect();const x=rect.left-gameContainerRect.left,y=rect.top-gameContainerRect.top;if(el.tagName==='H1'||el.classList.contains('gold-display'))uiParticles.push({type:'sparkleGenerator',x,y,width:rect.width,height:rect.height,spawnRate:.1});else for(let i=0;i<3;i++)uiParticles.push({type:'orbit',anchorX:x+rect.width/2,anchorY:y+rect.height/2,width:rect.width,height:rect.height,angle:Math.random()*Math.PI*2,speed:.01+Math.random()*.02,radius:1+Math.random(),color:'#ffd700'})})}
    function createStatsScreenParticles(){const gameContainerRect=document.getElementById('game-container').getBoundingClientRect();document.querySelectorAll('#player-screen .progress-bar-fill').forEach(el=>{const rect=el.getBoundingClientRect();if(rect.width<=0)return;const x=rect.left-gameContainerRect.left,y=rect.top-gameContainerRect.top,color=el.classList.contains('health')?'#e63946':el.classList.contains('attack')?'#fca311':el.classList.contains('rage')?'#9d4edd':el.classList.contains('regen')?'#52b788':'#00b4d8';uiParticles.push({type:'sparkleGenerator',x,y,width:rect.width,height:rect.height,spawnRate:rect.width/2e3,color})})}
    function setupNextStage(){enemies=[];const e=Math.min(2+Math.floor(currentStage/2),7),t=1+(currentStage-1)*.25,a=3+Math.floor(currentStage/3),s=Math.max(120-2*currentStage,45);for(let n=0;n<e;n++){const e=100+200*Math.random(),r=Math.floor((20+10*Math.random())*t);enemies.push({x:40+Math.random()*(canvas.width-80),y:e,baseY:e,hp:r,maxHp:r,attack:Math.floor(a+2*Math.random()),radius:20+5*Math.random(),color:"#e63946",attackCooldown:s+60*Math.random(),attackTimer:180*Math.random(),isAttacking:!1,chargeTimer:0})}}
    function updateShopUI(){dom.stageDisplay.textContent=currentStage;dom.goldDisplay.textContent=`${player.gold}`;document.getElementById('attack-power-stat').textContent=player.stats.attackPower.current;document.getElementById('max-health-stat').textContent=player.stats.maxHp.current;document.getElementById('rage-gain-stat').textContent=player.stats.rageGain.current;document.getElementById('health-regen-stat').textContent=player.stats.healthRegen.current.toFixed(1);document.getElementById('attack-cost').textContent=player.costs.attackPower;document.getElementById('health-cost').textContent=player.costs.maxHp;document.getElementById('rage-cost').textContent=player.costs.rageGain;document.getElementById('regen-cost').textContent=player.costs.healthRegen;dom.upgradeBtns.attack.classList.toggle('disabled',player.gold<player.costs.attackPower);dom.upgradeBtns.health.classList.toggle('disabled',player.gold<player.costs.maxHp);dom.upgradeBtns.rage.classList.toggle('disabled',player.gold<player.costs.rageGain);dom.upgradeBtns.regen.classList.toggle('disabled',player.gold<player.costs.healthRegen);}
    function updatePlayerScreenUI(){const statsContainer=document.querySelector(".stats-container"),skillsContainer=document.querySelector(".skills-container");statsContainer.innerHTML="";skillsContainer.innerHTML='<h2>Skills</h2>';Object.values(player.stats).forEach(stat=>{const progress=stat.current/stat.target*100,block=document.createElement("div");block.className="stat-block",block.innerHTML=`<div class="stat-header"><h3 id="stat-title-${stat.color}">${stat.name}</h3><span>Level ${stat.level}</span></div><p class="stat-value">${stat.isFloat?stat.current.toFixed(1):stat.current} / ${stat.target}${stat.displaySuffix}</p><div class="progress-bar-container"><div id="progress-${stat.color}" class="progress-bar-fill ${stat.color}" style="width: ${Math.min(progress,100)}%;"></div></div>`,statsContainer.appendChild(block)});Object.keys(SKILLS_DATA).forEach(id=>{const skillData=SKILLS_DATA[id],playerSkill=player.skills[id],block=document.createElement("div");block.className="skill-block";if(playerSkill.isUnlocked){const progress=playerSkill.currentXP/playerSkill.targetXP*100;block.innerHTML=`<div class="skill-header"><h3 id="skill-title-${id}">${skillData.name}</h3><span>Level ${playerSkill.level}</span></div><p>${getSkillDescription(id)}</p><div class="progress-bar-container"><div class="progress-bar-fill skill" style="width: ${Math.min(progress,100)}%;"></div></div>`}else{block.classList.add("locked");block.innerHTML=`<h3>${skillData.name}</h3><p>Unlock by clearing Stage ${skillData.unlockStage}</p>`}skillsContainer.appendChild(block)})}
    function getSkillDescription(id){const skillData=SKILLS_DATA[id],playerSkill=player.skills[id],level=playerSkill.level;const damage=Math.floor(player.stats.attackPower.current*(skillData.baseDamageMultiplier+(level-1)*skillData.damageMultiplierPerLevel));switch(id){case'orbitalStrike':return`Launches an orb dealing ${damage} damage.`;case'chainLightning':const jumps=skillData.baseJumps+Math.floor((level-1)/skillData.jumpsPerLevel);return`Lightning hits ${jumps+1} enemies for ${damage} damage.`;case'meteorShower':const count=skillData.baseCount+Math.floor((level-1)/skillData.countPerLevel);return`Calls down ${count} meteors that deal ${damage} damage.`}}
    function buyUpgrade(type){if(player.gold<player.costs[type])return;SOUNDS.upgrade();player.gold-=player.costs[type];player.costs[type]=Math.floor(1.15*player.costs[type]+5);const stat=player.stats[type];stat.current+=stat.baseGain;if(stat.current>=stat.target){SOUNDS.levelUp();stat.level++;stat.current-=stat.target;stat.target=Math.floor(1.8*stat.target);stat.baseGain=stat.isFloat?1.4*stat.baseGain:Math.ceil(1.5*stat.baseGain);const title=document.getElementById(`stat-title-${stat.color}`);title&&(title.classList.add("level-up"),setTimeout(()=>title.classList.remove("level-up"),1e3))}updateShopUI();gameState==="PLAYER_STATS"&&updatePlayerScreenUI();}
    function checkSkillUnlocks() {Object.keys(SKILLS_DATA).forEach(id => {const skillData = SKILLS_DATA[id], playerSkill = player.skills[id];if (!playerSkill.isUnlocked && currentStage > skillData.unlockStage) {playerSkill.isUnlocked = true;showBattleBanner(`${skillData.name} Unlocked!`, "ultimate-banner", 3000)}})}

    // --- EVENT LISTENERS ---
    dom.startBtn.onclick=()=>changeState('COMBAT');dom.nextBtn.onclick=()=>{currentStage++;changeState('COMBAT');};dom.retryBtn.onclick=()=>{player.hp=player.stats.maxHp.current;changeState('SHOP');};dom.resetBtn.onclick=resetGame;dom.statsBtn.onclick=()=>changeState('PLAYER_STATS');dom.backBtn.onclick=()=>changeState('SHOP');dom.upgradeBtns.attack.onclick=()=>buyUpgrade('attackPower');dom.upgradeBtns.health.onclick=()=>buyUpgrade('maxHp');dom.upgradeBtns.rage.onclick=()=>buyUpgrade('rageGain');dom.upgradeBtns.regen.onclick=()=>buyUpgrade('healthRegen');dom.autoBtn.onclick=()=>{isAutoBattle=!isAutoBattle;dom.autoBtn.classList.toggle('active',isAutoBattle);};dom.ultBtn.onclick=()=>{if(gameState!=='COMBAT'||player.rage<100)return;player.rage=0;SOUNDS.ultimate();showBattleBanner('RAGE BURST!','ultimate-banner',1500);triggerScreenShake(20);enemies.forEach(e=>{const t=5*player.stats.attackPower.current;e.hp-=t;createExplosion(e.x,e.y,40,'#f72585',5,10);addFloatingText(t,e.x,e.y,'#f72585');});};canvas.addEventListener('click',e=>{if(gameState!=='COMBAT')return;const t=canvas.getBoundingClientRect(),a=e.clientX-t.left,s=e.clientY-t.top;let n=null;enemies.forEach(e=>{Math.hypot(a-e.x,s-e.y)<e.radius&&(n=e)});isAutoBattle||playerAttack(n);healthOrbs.forEach((e,t)=>{if(Math.hypot(a-e.x,s-e.y)<e.radius){const a=Math.floor(.1*player.stats.maxHp.current);player.hp=Math.min(player.stats.maxHp.current,player.hp+a);addFloatingText(`+${a}`,player.x,player.y,'#4caf50');SOUNDS.heal();healthOrbs.splice(t,1);}});});
    
    // --- GAME LOOP & UPDATE ---
    function playerAttack(target){if(!target||player.isAttacking)return;player.isAttacking=!0;player.attackAnimTimer=20;SOUNDS.playerAttack();projectiles.push({x:player.x,y:player.y,target:target,speed:15,isPlayer:!0,damage:player.stats.attackPower.current+Math.floor(5*Math.random())})}
    function updateSkills(){if(enemies.length===0)return;Object.keys(player.skills).forEach(id=>{const skill=player.skills[id];if(!skill.isUnlocked)return;skill.cooldownTimer++;const skillData=SKILLS_DATA[id];const cooldown=Math.max(30,skillData.baseCooldown-(skill.level-1)*skillData.cooldownReductionPerLevel);if(skill.cooldownTimer>cooldown){skill.cooldownTimer=0;skill.currentXP++;if(skill.currentXP>=skill.targetXP){skill.level++;skill.currentXP-=skill.targetXP;skill.targetXP=Math.floor(skill.targetXP*1.5);SOUNDS.levelUp()}const damage=getSkillDescription(id).match(/\d+/)[0];const randomEnemy=enemies[Math.floor(Math.random()*enemies.length)];if(!randomEnemy)return;switch(id){case'orbitalStrike':skillVisuals.push({type:'orbitalStrike',x:player.x,y:player.y,target:randomEnemy,speed:3,damage,life:300});break;case'chainLightning':const jumps=SKILLS_DATA.chainLightning.baseJumps+Math.floor((skill.level-1)/SKILLS_DATA.chainLightning.jumpsPerLevel);let targets=[randomEnemy];for(let i=0;i<jumps;i++){const lastTarget=targets[targets.length-1],potentialNext=enemies.filter(e=>!targets.includes(e)).sort((a,b)=>Math.hypot(a.x-lastTarget.x,a.y-lastTarget.y)-Math.hypot(b.x-lastTarget.x,b.y-lastTarget.y));if(potentialNext.length>0)targets.push(potentialNext[0])}targets.forEach(e=>e.hp-=damage);skillVisuals.push({type:'chainLightning',targets,life:30});break;case'meteorShower':const count=SKILLS_DATA.meteorShower.baseCount+Math.floor((skill.level-1)/SKILLS_DATA.meteorShower.countPerLevel);for(let i=0;i<count;i++){const targetX=randomEnemy.x-100+200*Math.random();skillVisuals.push({type:'meteor',x:targetX,y:-50,targetY:randomEnemy.y-50+100*Math.random(),speed:8,damage,life:200})}break}}})}
    function updateCombat(){if(player.isAttacking){player.attackAnimTimer--;if(player.attackAnimTimer<=0)player.isAttacking=!1}if(isAutoBattle&&!player.isAttacking&&enemies.length>0){let e=enemies.reduce((e,t)=>Math.hypot(e.x-player.x,e.y-player.y)<Math.hypot(t.x-player.x,t.y-player.y)?e:t);playerAttack(e)}updateSkills();enemies.forEach(e=>{e.attackTimer++;if(e.attackTimer>=e.attackCooldown&&!e.isAttacking){e.isAttacking=!0;e.chargeTimer=30}if(e.chargeTimer>0){e.chargeTimer--;if(e.chargeTimer<=0){e.attackTimer=0;SOUNDS.enemyAttack();projectiles.push({x:e.x,y:e.y,target:player,speed:10,isPlayer:!1,damage:e.attack})}}else if(e.isAttacking)e.isAttacking=!1;if(e.flash>0)e.flash--});projectiles.forEach((e,t)=>{const a=e.target.x-e.x,s=e.target.y-e.y,n=Math.hypot(a,s);if(n<e.speed){e.target.hp-=e.damage;e.target.flash=5;if(e.isPlayer)player.rage=Math.min(player.rage+player.stats.rageGain.current,100);SOUNDS.hit();triggerScreenShake(e.isPlayer?5:8);createExplosion(e.target.x,e.target.y,20,e.isPlayer?"#fff":"#ff4d4d");addFloatingText(e.damage,e.target.x,e.y,e.isPlayer?"#ffd700":"#ff4d4d");projectiles.splice(t,1)}else{e.x+=a/n*e.speed;e.y+=s/n*e.speed}});if(player.hp<=0)return SOUNDS.gameOver(),void changeState("GAME_OVER");const deadEnemies=enemies.filter(e=>e.hp<=0);deadEnemies.forEach(e=>{createExplosion(e.x,e.y,50,e.color,4,8);SOUNDS.enemyDeath();player.gold+=Math.floor(1.5*currentStage+5)});enemies=enemies.filter(e=>e.hp>0);if(enemies.length===0&&gameState==="COMBAT")changeState("ENDING_COMBAT");if(Math.random()<.005&&healthOrbs.length<3)healthOrbs.push({x:40+Math.random()*(canvas.width-80),y:100+300*Math.random(),radius:12,life:600,pulse:0})}
    function update(){if(gameState==='COMBAT')updateCombat();if(gameState==='ENDING_COMBAT'){endCombatTimer--;if(endCombatTimer<=0){player.hp=Math.min(player.stats.maxHp.current,player.hp+Math.floor(.2*player.stats.maxHp.current));changeState('SHOP')}}if(player.hp<player.stats.maxHp.current&&player.stats.healthRegen.current>0&&(gameState==='COMBAT'||gameState==='ENDING_COMBAT'))player.hp=Math.min(player.stats.maxHp.current,player.hp+player.stats.healthRegen.current/60);healthOrbs=healthOrbs.filter(e=>{e.life--;e.pulse+=.1;if(isAutoBattle){const t=player.x-e.x,a=player.y-e.y;if(Math.hypot(t,a)<player.size){const t=Math.floor(.1*player.stats.maxHp.current);return player.hp=Math.min(player.stats.maxHp.current,player.hp+t),addFloatingText(`+${t}`,player.x,player.y,"#4caf50"),SOUNDS.heal(),!1}e.x+=.03*t;e.y+=.03*a}return e.life>0});skillVisuals.forEach((v,i)=>{v.life--;if(v.life<=0)skillVisuals.splice(i,1);switch(v.type){case'orbitalStrike':const dx=v.target.x-v.x,dy=v.target.y-v.y,dist=Math.hypot(dx,dy);if(dist<v.speed){v.target.hp-=v.damage;createExplosion(v.x,v.y,20,'#9d4edd');v.life=0}else{v.x+=dx/dist*v.speed;v.y+=dy/dist*v.speed}break;case'meteor':v.y+=v.speed;if(v.y>=v.targetY){enemies.forEach(e=>{if(Math.abs(e.x-v.x)<30)e.hp-=v.damage});createExplosion(v.x,v.y,30,'#fca311');v.life=0}break}});window.stars.forEach(e=>{e.y+=e.speed;if(e.y>canvas.height){e.y=0;e.x=Math.random()*canvas.width}});particles=particles.filter(e=>{e.x+=e.vx;e.y+=e.vy;e.life--;return e.life>0});floatingTexts=floatingTexts.filter(e=>{e.y-=1;e.life--;return e.life>0});updateUiParticles()}
    function updateUiParticles(){const newParticles=[];uiParticles.forEach(p=>{if(p.type==='orbit')p.angle+=p.speed;else if(p.type==='sparkleGenerator'){if(Math.random()<p.spawnRate)newParticles.push({type:'sparkle',x:p.x+Math.random()*p.width,y:p.y+Math.random()*p.height,life:60,maxLife:60,radius:Math.random()*2,color:typeof p.color==='string'?p.color:`rgba(255,220,150,${.5+Math.random()*.5})`});}else if(p.type==='sparkle')p.life--;});uiParticles=uiParticles.filter(p=>!(p.type==='sparkle'&&p.life<=0));uiParticles.push(...newParticles)}
    
    // --- DRAW FUNCTIONS ---
    function drawHud(){if(gameState!=='COMBAT')return;ctx.save();ctx.font='bold 24px Segoe UI';ctx.shadowColor='black';ctx.shadowBlur=5;ctx.fillStyle='white';ctx.textAlign='left';ctx.fillText(`Stage: ${currentStage}`,15,35);ctx.textAlign='right';ctx.fillStyle='#ffd700';ctx.fillText(`ðŸ’° ${player.gold}`,canvas.width-15,35);ctx.restore()}
    function drawUiParticles(){uiCtx.clearRect(0,0,uiCanvas.width,uiCanvas.height);if(gameState!=='SHOP'&&gameState!=='PLAYER_STATS')return;uiParticles.forEach(p=>{if(p.type==='orbit'){const orbitX=p.anchorX+Math.cos(p.angle)*(p.width/2+10),orbitY=p.anchorY+Math.sin(p.angle)*(p.height/2+10);uiCtx.beginPath();uiCtx.arc(orbitX,orbitY,p.radius,0,Math.PI*2);uiCtx.fillStyle=p.color;uiCtx.globalAlpha=.8;uiCtx.fill()}else if(p.type==='sparkle'){uiCtx.beginPath();uiCtx.arc(p.x,p.y,p.radius,0,Math.PI*2);uiCtx.fillStyle=p.color;uiCtx.globalAlpha=p.life/p.maxLife*.8;uiCtx.fill()}});uiCtx.globalAlpha=1}
    function drawBackground(){ctx.fillStyle='#0c0c14';ctx.fillRect(0,0,canvas.width,canvas.height);window.stars.forEach(s=>{ctx.beginPath();ctx.arc(s.x,s.y,s.radius,0,Math.PI*2);ctx.fillStyle=`rgba(255,255,255,${.5+s.speed})`;ctx.fill()})}
    function drawPlayer(){dom.ultBtn.classList.toggle('is-flashing',player.rage>=100);dom.ultBtn.style.background=player.rage>=100?'#f72585':'#5a1835';dom.autoBtn.classList.toggle('active',isAutoBattle);ctx.save();ctx.translate(player.x,player.y);ctx.shadowColor='rgba(0,0,0,0.5)';ctx.shadowBlur=10;ctx.shadowOffsetY=5;ctx.fillStyle=player.color;ctx.fillRect(-player.size/2,-player.size/2,player.size,player.size);if(player.isAttacking){player.sword.angle+=.5}else{player.sword.angle+=(0-player.sword.angle)*.2}ctx.rotate(player.sword.angle);ctx.fillStyle='#ddd';ctx.fillRect(player.size/2,-3,player.sword.length,6);ctx.restore();const barWidth=100,barX=player.x-barWidth/2;ctx.fillStyle='#333';ctx.fillRect(barX,player.y+player.size/2+5,barWidth,12);ctx.fillStyle='#2a9d8f';ctx.fillRect(barX,player.y+player.size/2+5,barWidth*Math.max(0,player.hp/player.stats.maxHp.current),12);ctx.fillStyle='#554300';ctx.fillRect(barX,player.y+player.size/2+18,barWidth,8);ctx.fillStyle='#ffd700';ctx.fillRect(barX,player.y+player.size/2+18,barWidth*(player.rage/100),8)}
    function drawEnemies(){enemies.forEach(e=>{ctx.save();ctx.translate(e.x,e.y);ctx.shadowColor='rgba(0,0,0,0.5)';ctx.shadowBlur=10;ctx.shadowOffsetY=5;ctx.beginPath();ctx.arc(0,0,e.radius,0,Math.PI*2);ctx.fillStyle=e.chargeTimer>0?'#ff6b6b':e.color;ctx.fill();ctx.restore();if(e.flash>0){ctx.beginPath();ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);ctx.fillStyle=`rgba(255,255,255,${e.flash/5})`}const barWidth=e.radius*2;ctx.fillStyle='#333';ctx.fillRect(e.x-e.radius,e.y-e.radius-15,barWidth,5);ctx.fillStyle='#c1121f';ctx.fillRect(e.x-e.radius,e.y-e.radius-15,barWidth*Math.max(0,e.hp/e.maxHp),5)})}
    function drawHealthOrbs(){healthOrbs.forEach(orb=>{ctx.save();ctx.globalAlpha=.5+Math.sin(orb.pulse)*.3;ctx.beginPath();ctx.arc(orb.x,orb.y,orb.radius,0,Math.PI*2);ctx.fillStyle='#4caf50';ctx.fill();ctx.shadowColor='#abffc0';ctx.shadowBlur=15;ctx.fill();ctx.restore()})}
    function drawSkillVisuals(){skillVisuals.forEach(v=>{ctx.save();ctx.globalAlpha=v.life/30;switch(v.type){case'orbitalStrike':ctx.fillStyle='#9d4edd';ctx.beginPath();ctx.arc(v.x,v.y,8,0,2*Math.PI);ctx.fill();ctx.shadowColor='#fff';ctx.shadowBlur=10;ctx.fill();break;case'chainLightning':ctx.strokeStyle='#00b4d8';ctx.lineWidth=3;ctx.shadowColor='#ade8f4';ctx.shadowBlur=15;ctx.beginPath();ctx.moveTo(v.targets[0].x,v.targets[0].y);for(let i=1;i<v.targets.length;i++)ctx.lineTo(v.targets[i].x,v.targets[i].y);ctx.stroke();break;case'meteor':ctx.fillStyle='#fca311';ctx.beginPath();ctx.rect(v.x-3,v.y-15,6,30);ctx.fill();break}ctx.restore()})}
    function drawEffects(){projectiles.forEach(p=>{ctx.fillStyle=p.isPlayer?'#fff':'#ff4d4d';ctx.beginPath();ctx.arc(p.x,p.y,5,0,2*Math.PI);ctx.fill()});particles.forEach(p=>{ctx.fillStyle=p.color;ctx.globalAlpha=p.life/30;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,2*Math.PI);ctx.fill()});ctx.globalAlpha=1;floatingTexts.forEach(t=>{ctx.font='bold 28px sans-serif';ctx.fillStyle=t.color;ctx.globalAlpha=t.life/60;ctx.textAlign='center';ctx.shadowColor='black';ctx.shadowBlur=4;ctx.fillText(t.text,t.x,t.y)});ctx.shadowBlur=0;ctx.shadowColor='transparent';ctx.globalAlpha=1}
    function draw(){drawBackground();ctx.save();if(shakeDuration>0){ctx.translate(Math.random()*6-3,Math.random()*6-3);shakeDuration--}if(gameState==='COMBAT'||gameState==='ENDING_COMBAT'){drawPlayer();drawEnemies();drawHealthOrbs();drawEffects();drawSkillVisuals()}ctx.restore();drawHud();drawUiParticles()}
    function gameLoop(){update();draw();requestAnimationFrame(gameLoop)}
    initGame();
    requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
