<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Audio Stem Separator (Demucs)</title>
    <!-- Main AdSense Script (include only ONCE per page) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5972331036113330"
     crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-bg: #1e1e2f;
            --secondary-bg: #27293d;
            --accent-color: #00bcd4;
            --progress-bar-color: #00acc1; /* Or use var(--accent-color) */
            --text-color: #f8f8f2;
            --input-bg: #44475a;
            --success-color: #50fa7b;
            --error-color: #ff5555;
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-color); overscroll-behavior-y: contain; }
        .app-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; padding: 20px; text-align: center; }
        .title { font-size: 2.5em; margin-bottom: 20px; color: var(--accent-color); font-weight: 300; }
        .ad-container { width: 100%; max-width: 728px; min-height: 90px; margin: 20px auto; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .upload-group { width: 100%; max-width: 500px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .file-input-label { display: inline-block; padding: 12px 20px; font-size: 1em; font-weight: bold; color: var(--text-color); background-color: var(--input-bg); border: 1px dashed var(--accent-color); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease; margin-bottom: 15px; }
        .file-input-label:hover { background-color: #5a5d74; border-color: #00acc1; }
        #audioFile { display: none; }
        #fileNameDisplay { font-size: 0.9em; color: #bd93f9; min-height: 1.2em; margin-bottom: 15px; word-break: break-all; }
        .action-button { padding: 15px 30px; font-size: 1.1em; font-weight: bold; color: var(--text-color); background-color: var(--accent-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; outline: none; width: 100%; max-width: 500px; }
        .action-button:hover { background-color: #00acc1; }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #6272a4; cursor: not-allowed; }
        .status-message { margin-top: 20px; font-size: 0.9em; min-height: 1.2em; color: var(--text-color); white-space: pre-wrap; }
        .status-message.success { color: var(--success-color); }
        .status-message.error { color: var(--error-color); }
        #progressContainer { width: 100%; max-width: 500px; display: none; margin-top: 15px; }
        #progressBarOuter { background-color: var(--input-bg); border-radius: var(--border-radius); padding: 3px; }
        #progressBarInner { background-color: var(--progress-bar-color); width: 0%; height: 20px; border-radius: 5px; text-align: center; line-height: 20px; color: var(--primary-bg); font-weight: bold; transition: width 0.5s ease-out; }
        #progressLog { font-size: 0.8em; color: #9a9a9a; margin-top: 8px; text-align: left; max-height: 100px; overflow-y: auto; background-color: var(--secondary-bg); padding: 5px; border-radius: var(--border-radius); white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="title">Audio Stem Separator</h1>
        <div id="adContainer1" class="ad-container"></div> <!-- Placeholder for first ad unit -->
        <div class="upload-group">
            <label for="audioFile" class="file-input-label">Choose Audio File (e.g., MP3, WAV)</label>
            <input type="file" id="audioFile" name="audioFile" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac">
            <p id="fileNameDisplay">No file selected</p>
        </div>
        <button id="processBtn" class="action-button" disabled>Separate Stems</button>
        <p id="statusMessage" class="status-message"></p>
        <div id="progressContainer">
            <div id="progressBarOuter">
                <div id="progressBarInner">0%</div>
            </div>
            <div id="progressLog"></div>
        </div>
        <div id="adContainer2" class="ad-container"></div> <!-- Placeholder for second ad unit -->
    </div>

    <script>
        const audioFileInput = document.getElementById('audioFile');
        const processBtn = document.getElementById('processBtn');
        const statusMessage = document.getElementById('statusMessage');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const adContainer1 = document.getElementById('adContainer1');
        const adContainer2 = document.getElementById('adContainer2');
        const progressContainer = document.getElementById('progressContainer');
        const progressBarInner = document.getElementById('progressBarInner');
        const progressLog = document.getElementById('progressLog');

        let progressInterval = null;
        const ESTIMATED_MAX_PROCESSING_TIME_SECONDS = 10 * 60; // 10 minutes (adjust as needed)

        // --- SERVER CONFIGURATION ---
        const YOUR_DDNS_HOSTNAME = 'vicsanitymp3.servemp3.com';
        const SERVER_ENDPOINT_BASE = `https://${YOUR_DDNS_HOSTNAME}`;
        const SERVER_ENDPOINT = `${SERVER_ENDPOINT_BASE}/separate-stems`;
        let selectedFile = null;
        
        // --- AdSense Configuration ---
        const YOUR_ADSENSE_PUBLISHER_ID = "ca-pub-5972331036113330"; // Your Publisher ID
        const AD_SLOT_ID_1 = "7200779658"; // From your "MP3" ad unit
        const AD_SLOT_ID_2 = "4287691766"; // From your "MP3Finished" ad unit

        const adSlot1HTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="${YOUR_ADSENSE_PUBLISHER_ID}" data-ad-slot="${AD_SLOT_ID_1}" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
        const adSlot2HTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="${YOUR_ADSENSE_PUBLISHER_ID}" data-ad-slot="${AD_SLOT_ID_2}" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
        // --- End AdSense Configuration ---

        function showAd(adContainerElement, adSlotHTMLContent) {
            if (adContainerElement && adSlotHTMLContent) {
                adContainerElement.innerHTML = adSlotHTMLContent;
                adContainerElement.style.display = 'flex';
                try { (adsbygoogle = window.adsbygoogle || []).push({}); }
                catch (e) { console.error('Error pushing AdSense ad for ' + adContainerElement.id + ':', e); }
            }
        }
        function hideAd(adContainerElement) { if (adContainerElement) { adContainerElement.style.display = 'none'; adContainerElement.innerHTML = ''; } }

        function startSimulatedProgress() {
            hideAd(adContainer1); hideAd(adContainer2);
            progressContainer.style.display = 'block';
            progressBarInner.style.width = '0%';
            progressBarInner.textContent = '0%';
            progressBarInner.style.backgroundColor = 'var(--progress-bar-color)';
            progressLog.innerHTML = 'Processing started...<br>';
            let elapsedTime = 0;
            const updateInterval = 1000;
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                elapsedTime += updateInterval / 1000;
                let percent = Math.min((elapsedTime / ESTIMATED_MAX_PROCESSING_TIME_SECONDS) * 100, 99);
                progressBarInner.style.width = percent + '%';
                progressBarInner.textContent = Math.round(percent) + '%';
                if (elapsedTime % 15 === 0 && percent < 90) appendToProgressLog(`Still working hard... ${Math.round(elapsedTime)}s passed.`);
                if (percent >= 99) { clearInterval(progressInterval); progressInterval = null; }
            }, updateInterval);
        }

        function stopSimulatedProgress(success = true) {
            if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
            if (success) {
                progressBarInner.style.width = '100%';
                progressBarInner.textContent = '100%';
                appendToProgressLog('Processing complete!');
            } else {
                progressBarInner.style.backgroundColor = 'var(--error-color)';
            }
        }

        function appendToProgressLog(message) {
            const maxLogLines = 5;
            let currentLogContent = progressLog.innerHTML;
            let lines = currentLogContent.split('<br>');
            // Remove empty strings from split if last char was <br>
            if (lines[lines.length -1] === "") lines.pop(); 
            
            while(lines.length >= maxLogLines) {
                lines.shift(); // Remove oldest line from the top
            }
            currentLogContent = lines.join('<br>');
            if(lines.length > 0 && currentLogContent) { // Add <br> only if there was previous content
                 progressLog.innerHTML = currentLogContent + '<br>' + message.replace(/\n/g, '<br>') + '<br>';
            } else {
                 progressLog.innerHTML = message.replace(/\n/g, '<br>') + '<br>';
            }
            progressLog.scrollTop = progressLog.scrollHeight;
        }
        
        audioFileInput.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                fileNameDisplay.textContent = selectedFile.name;
                processBtn.disabled = false;
                processBtn.textContent = 'Separate Stems';
                setStatus(''); 
            } else {
                fileNameDisplay.textContent = 'No file selected';
                processBtn.disabled = true;
                processBtn.textContent = 'Separate Stems';
            }
        });

        processBtn.addEventListener('click', handleSeparation);

        async function handleSeparation() {
            if (!selectedFile) { setStatus('Please select an audio file first.', 'error'); return; }
            const MAX_FRONTEND_SIZE_MB = 100;
            if (selectedFile.size > MAX_FRONTEND_SIZE_MB * 1024 * 1024) {
                setStatus(`File is too large (max ${MAX_FRONTEND_SIZE_MB}MB).`, 'error');
                progressContainer.style.display = 'none';
                return;
            }

            setStatus('Your request is being processed. If no one else is ahead of you, this should take 5-10 min for a high-quality 5-min audio file. Please be patient. The progress bar will simulate progress.', '');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';
            startSimulatedProgress();

            const formData = new FormData();
            formData.append('audioFile', selectedFile); 

            try {
                const response = await fetch(SERVER_ENDPOINT, { method: 'POST', body: formData });
                if (!response.ok) {
                    stopSimulatedProgress(false);
                    let errorMsg = `Server error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) { errorMsg = errorData.error; if (errorData.details) { appendToProgressLog(`Server Detail: ${errorData.details.substring(0, 100)}...`); } }
                    } catch (e) { try { const textError = await response.text(); if(textError) { errorMsg = textError.substring(0,150); appendToProgressLog(`Server Error: ${textError.substring(0,100)}...`);} } catch (textE) {} }
                    throw new Error(errorMsg);
                }

                stopSimulatedProgress(true);
                const blob = await response.blob();
                let downloadFilename = "stems.zip";
                const disposition = response.headers.get('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) { downloadFilename = matches[1].replace(/['"]/g, ''); }
                } else {
                    const originalFilenameBase = selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.')) || 'audio';
                    downloadFilename = `${originalFilenameBase}_stems.zip`;
                }
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = downloadUrl; a.download = downloadFilename;
                document.body.appendChild(a); a.click();
                setStatus(`Stems downloaded as ${downloadFilename}! Check your downloads.`, 'success');
                appendToProgressLog(`Download started: ${downloadFilename}`);
                setTimeout(() => { if (downloadUrl) window.URL.revokeObjectURL(downloadUrl); if (a && a.parentElement) a.remove(); }, 3000);
                
                showAd(adContainer1, adSlot1HTML); // Show ads again after successful processing
                // showAd(adContainer2, adSlot2HTML); // You can decide to show the second one here too
                
            } catch (error) {
                stopSimulatedProgress(false);
                console.error('Separation error:', error);
                setStatus(`Error: ${error.message}`, 'error');
                appendToProgressLog(`ERROR: ${error.message}`);
            } finally {
                processBtn.disabled = false; processBtn.textContent = 'Separate Stems';
                audioFileInput.value = null; selectedFile = null;
                fileNameDisplay.textContent = 'No file selected'; processBtn.disabled = true;
            }
        }

        function setStatus(message, type = '') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            if (type) { statusMessage.classList.add(type); }
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusMessage.textContent === message) {
                         statusMessage.textContent = '';
                         statusMessage.className = 'status-message';
                         progressContainer.style.display = 'none'; 
                         showAd(adContainer1, adSlot1HTML); // Make sure ads are visible again
                         showAd(adContainer2, adSlot2HTML);
                    }
                }, 10000);
            } else if (!message) {
                progressContainer.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            processBtn.disabled = true;
            showAd(adContainer1, adSlot1HTML);
            showAd(adContainer2, adSlot2HTML);
        });
    </script>
</body>
</html>
