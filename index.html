<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Audio Stem Separator</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5972331036113330"
     crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-bg: #1e1e2f;
            --secondary-bg: #27293d;
            --accent-color: #00bcd4; /* Changed accent for a new feel */
            --text-color: #f8f8f2;
            --input-bg: #44475a;
            --success-color: #50fa7b;
            --error-color: #ff5555;
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-color); overscroll-behavior-y: contain; }

        .app-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; padding: 20px; text-align: center; }
        .title { font-size: 2.5em; margin-bottom: 30px; color: var(--accent-color); font-weight: 300; }

        .upload-group { width: 100%; max-width: 500px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color);
            background-color: var(--input-bg); /* Changed from accent to input for better contrast */
            border: 1px dashed var(--accent-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            margin-bottom: 15px;
        }
        .file-input-label:hover { background-color: #5a5d74; border-color: #00acc1; }
        #audioFile { display: none; } /* Hide the default file input */
        #fileNameDisplay { font-size: 0.9em; color: #bd93f9; min-height: 1.2em; margin-bottom: 15px; word-break: break-all; }

        .action-button {
            padding: 15px 30px; font-size: 1.1em; font-weight: bold; color: var(--text-color);
            background-color: var(--accent-color); border: none; border-radius: var(--border-radius);
            cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease;
            outline: none; width: 100%; max-width: 500px;
        }
        .action-button:hover { background-color: #00acc1; /* Darker shade of accent */ }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #6272a4; cursor: not-allowed; }

        .status-message { margin-top: 20px; font-size: 0.9em; min-height: 1.2em; color: var(--text-color); }
        .status-message.success { color: var(--success-color); }
        .status-message.error { color: var(--error-color); }

        .spinner {
            display: none; border: 4px solid rgba(248, 248, 242, 0.3);
            border-radius: 50%; border-top: 4px solid var(--accent-color);
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto 0;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ad-container {
            display: none;
            width: 100%;
            max-width: 500px;
            margin: 25px auto;
            /* border: 1px solid #44475a;  Removed red dashed border */
            min-height: 50px; /* AdSense responsive ads will try to fill this */
            background-color: var(--secondary-bg); /* Subtle background for the ad area */
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="title">Audio Stem Separator</h1>

        <div class="upload-group">
            <label for="audioFile" class="file-input-label">Choose Audio File (e.g., MP3, WAV)</label>
            <input type="file" id="audioFile" accept="audio/*">
            <p id="fileNameDisplay">No file selected</p>
        </div>

        <button id="processBtn" class="action-button" disabled>Separate Stems</button>

        <div id="adContainer1" class="ad-container"></div>
        <div id="spinner" class="spinner"></div>
        <p id="statusMessage" class="status-message"></p>
        <div id="adContainer2" class="ad-container"></div>
    </div>

    <script>
        const audioFileInput = document.getElementById('audioFile');
        const processBtn = document.getElementById('processBtn');
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const adContainer1 = document.getElementById('adContainer1');
        const adContainer2 = document.getElementById('adContainer2');

        // IMPORTANT: Update this to your Render service URL!
        const SERVER_ENDPOINT_BASE = 'https://mp3-downloader-backend.onrender.com'; // Replace with your actual Render app URL
        const SERVER_ENDPOINT = `${SERVER_ENDPOINT_BASE}/separate-stems`;
        let selectedFile = null;

        // --- AdSense ---
        const adSlot1HTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5972331036113330" data-ad-slot="7200779658" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
        const adSlot2HTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5972331036113330" data-ad-slot="4287691766" data-ad-format="auto" data-full-width-responsive="true"></ins>`;

        function showAd(adContainerElement, adSlotHTML) {
            if (adContainerElement) {
                adContainerElement.innerHTML = adSlotHTML;
                adContainerElement.style.display = 'block'; // Make sure it's visible
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                    console.log('AdSense push for ad in container:', adContainerElement.id);
                } catch (e) {
                    console.error('Error pushing AdSense ad for ' + adContainerElement.id + ':', e);
                }
            }
        }

        function hideAd(adContainerElement) {
            if (adContainerElement) {
                adContainerElement.style.display = 'none';
                adContainerElement.innerHTML = ''; // Clear content
            }
        }

        // --- File Input Handling ---
        audioFileInput.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                fileNameDisplay.textContent = selectedFile.name;
                processBtn.disabled = false;
                processBtn.textContent = 'Separate Stems';
                setStatus(''); // Clear previous status
            } else {
                fileNameDisplay.textContent = 'No file selected';
                processBtn.disabled = true;
                processBtn.textContent = 'Separate Stems'; // Reset button text
            }
        });

        // --- Process Button Click ---
        processBtn.addEventListener('click', handleSeparation);

        async function handleSeparation() {
            if (!selectedFile) {
                setStatus('Please select an audio file first.', 'error');
                return;
            }

            setStatus('Uploading and processing... This may take a while.', '');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';
            spinner.style.display = 'block';
            hideAd(adContainer1); // Hide ads during processing
            hideAd(adContainer2);

            const formData = new FormData();
            formData.append('audioFile', selectedFile); // 'audioFile' must match backend field name (multer)

            try {
                const response = await fetch(SERVER_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                    // No 'Content-Type' header needed for FormData; browser sets it with boundary
                });

                if (!response.ok) {
                    let errorMsg = `Server error: ${response.status}`;
                    try {
                        const errorData = await response.json(); // Try to parse JSON error from backend
                        if (errorData && errorData.error) errorMsg = errorData.error;
                    } catch (e) {
                        // If not JSON, try to get text error
                        try {
                            const textError = await response.text();
                            if(textError) errorMsg = textError.substring(0,200); // Get first 200 chars
                        } catch (textE) { /* ignore if text parsing also fails */ }
                    }
                    throw new Error(errorMsg);
                }

                // Assuming the server responds with a ZIP file containing all stems
                const blob = await response.blob();
                const originalFilenameBase = selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.')) || 'audio_stems';
                const downloadFilename = `${originalFilenameBase}_stems.zip`;

                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                a.download = downloadFilename;
                document.body.appendChild(a);
                a.click();

                setStatus(`Stems downloaded as ${downloadFilename}! Check your downloads.`, 'success');
                
                setTimeout(() => {
                    if (downloadUrl) window.URL.revokeObjectURL(downloadUrl);
                    if (a && a.parentElement) a.remove();
                    console.log("Object URL revoked and 'a' element removed after delay.");
                }, 3000); // Increased delay slightly
                
                showAd(adContainer1, adSlot1HTML); // Show ad again after success

            } catch (error) {
                console.error('Separation error:', error);
                setStatus(`Error: ${error.message}`, 'error');
                // Optionally show a different ad or no ad on error
                // showAd(adContainer2, adSlot2HTML);
            } finally {
                processBtn.disabled = false; // Re-enable button
                processBtn.textContent = 'Separate Stems'; // Reset button text
                spinner.style.display = 'none';

                // Reset file input for next use
                audioFileInput.value = null; // This clears the selected file from the input element
                selectedFile = null;
                fileNameDisplay.textContent = 'No file selected';
                processBtn.disabled = true; // Disable button until a new file is selected
            }
        }

        function setStatus(message, type = '') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message'; // Reset classes
            if (type) {
                statusMessage.classList.add(type);
            }
            // Auto-clear status message after some time, only for success/error
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusMessage.textContent === message) { // Only clear if it's still the same message
                         statusMessage.textContent = '';
                         statusMessage.className = 'status-message'; // Reset classes
                    }
                }, 7000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            hideAd(adContainer1);
            hideAd(adContainer2);
            // Ensure button is disabled initially as no file is selected
            processBtn.disabled = true;
        });

    </script>
</body>
</html>
