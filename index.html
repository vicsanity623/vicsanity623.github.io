<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Audio Stem Separator (Demucs)</title>
    <!-- STEP 1: Main AdSense Script - YOUR PUBLISHER ID IS ALREADY HERE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5972331036113330"
     crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-bg: #1e1e2f;
            --secondary-bg: #27293d;
            --accent-color: #00bcd4;
            --text-color: #f8f8f2;
            --input-bg: #44475a;
            --success-color: #50fa7b;
            --error-color: #ff5555;
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-color); overscroll-behavior-y: contain; }

        .app-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; padding: 20px; text-align: center; }
        .title { font-size: 2.5em; margin-bottom: 20px; color: var(--accent-color); font-weight: 300; }

        /* CSS for Ad Containers */
        .ad-container {
            width: 100%;
            max-width: 728px; /* Adjust as needed, e.g., 320px for mobile banners, 'auto' for responsive */
            min-height: 90px;  /* AdSense needs some space to fill */
            margin: 20px auto; 
            background-color: var(--secondary-bg); 
            display: flex; 
            justify-content: center;
            align-items: center;
            overflow: hidden; /* For responsive ads */
            /* border: 1px dashed red; /* For debugging ad placement */
        }

        .upload-group { width: 100%; max-width: 500px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .file-input-label {
            display: inline-block; padding: 12px 20px; font-size: 1em; font-weight: bold;
            color: var(--text-color); background-color: var(--input-bg);
            border: 1px dashed var(--accent-color); border-radius: var(--border-radius);
            cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease;
            margin-bottom: 15px;
        }
        .file-input-label:hover { background-color: #5a5d74; border-color: #00acc1; }
        #audioFile { display: none; }
        #fileNameDisplay { font-size: 0.9em; color: #bd93f9; min-height: 1.2em; margin-bottom: 15px; word-break: break-all; }

        .action-button {
            padding: 15px 30px; font-size: 1.1em; font-weight: bold; color: var(--text-color);
            background-color: var(--accent-color); border: none; border-radius: var(--border-radius);
            cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease;
            outline: none; width: 100%; max-width: 500px;
        }
        .action-button:hover { background-color: #00acc1; }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #6272a4; cursor: not-allowed; }

        .status-message { margin-top: 20px; font-size: 0.9em; min-height: 1.2em; color: var(--text-color); white-space: pre-wrap; }
        .status-message.success { color: var(--success-color); }
        .status-message.error { color: var(--error-color); }

        .spinner {
            display: none; border: 4px solid rgba(248, 248, 242, 0.3);
            border-radius: 50%; border-top: 4px solid var(--accent-color);
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto 0;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="title">Audio Stem Separator</h1>

        <!-- Ad Slot 1 Placeholder -->
        <div id="adContainer1" class="ad-container"></div>

        <div class="upload-group">
            <label for="audioFile" class="file-input-label">Choose Audio File (e.g., MP3, WAV)</label>
            <input type="file" id="audioFile" name="audioFile" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac">
            <p id="fileNameDisplay">No file selected</p>
        </div>

        <button id="processBtn" class="action-button" disabled>Separate Stems</button>

        <div id="spinner" class="spinner"></div>
        <p id="statusMessage" class="status-message"></p>

        <!-- Ad Slot 2 Placeholder -->
        <div id="adContainer2" class="ad-container"></div>
    </div>

    <script>
        const audioFileInput = document.getElementById('audioFile');
        const processBtn = document.getElementById('processBtn');
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const adContainer1 = document.getElementById('adContainer1');
        const adContainer2 = document.getElementById('adContainer2');

        // --- SERVER CONFIGURATION ---
        const YOUR_DDNS_HOSTNAME = 'vicsanitymp3.servemp3.com';
        const SERVER_ENDPOINT_BASE = `https://${YOUR_DDNS_HOSTNAME}`;
        const SERVER_ENDPOINT = `${SERVER_ENDPOINT_BASE}/separate-stems`;
        let selectedFile = null;
        
        // --- AdSense Configuration - REPLACE AD SLOT IDs ---
        const YOUR_ADSENSE_PUBLISHER_ID = "ca-pub-5972331036113330"; // Your Publisher ID
        
        // YOU MUST REPLACE THESE WITH YOUR ACTUAL AD SLOT IDs FROM ADSENSE
        const YOUR_AD_SLOT_ID_1 = "YOUR_AD_SLOT_ID_1"; // REPLACE: Ad Slot ID for adContainer1
        const YOUR_AD_SLOT_ID_2 = "YOUR_AD_SLOT_ID_2"; // REPLACE: Ad Slot ID for adContainer2

        const adSlot1HTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="${YOUR_ADSENSE_PUBLISHER_ID}" data-ad-slot="${YOUR_AD_SLOT_ID_1}" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
        const adSlot2HTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="${YOUR_ADSENSE_PUBLISHER_ID}" data-ad-slot="${YOUR_AD_SLOT_ID_2}" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
        // --- End AdSense Configuration ---

        function showAd(adContainerElement, adSlotHTMLContent) {
            if (adContainerElement && adSlotHTMLContent) {
                // Check if the slot IDs are still placeholders
                if (adSlotHTMLContent.includes("YOUR_AD_SLOT_ID_")) {
                    console.warn("AdSense: Ad Slot ID is a placeholder for container:", adContainerElement.id, ". Ad will not load correctly.");
                    // Optionally, you could hide the container or show a message
                    // adContainerElement.style.display = 'none'; 
                    // adContainerElement.innerHTML = 'Ad slot not configured.';
                    return; // Don't try to push if slot ID is placeholder
                }
                adContainerElement.innerHTML = adSlotHTMLContent;
                adContainerElement.style.display = 'flex'; // Use flex as per CSS
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.error('Error pushing AdSense ad for ' + adContainerElement.id + ':', e);
                }
            }
        }

        function hideAd(adContainerElement) {
            if (adContainerElement) {
                adContainerElement.style.display = 'none';
                adContainerElement.innerHTML = '';
            }
        }

        audioFileInput.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                fileNameDisplay.textContent = selectedFile.name;
                processBtn.disabled = false;
                processBtn.textContent = 'Separate Stems';
                setStatus('');
            } else {
                fileNameDisplay.textContent = 'No file selected';
                processBtn.disabled = true;
                processBtn.textContent = 'Separate Stems';
            }
        });

        processBtn.addEventListener('click', handleSeparation);

        async function handleSeparation() {
            if (!selectedFile) {
                setStatus('Please select an audio file first.', 'error');
                return;
            }

            const MAX_FRONTEND_SIZE_MB = 100;
            if (selectedFile.size > MAX_FRONTEND_SIZE_MB * 1024 * 1024) {
                setStatus(`File is too large (max ${MAX_FRONTEND_SIZE_MB}MB).`, 'error');
                return;
            }

            setStatus('Uploading and processing... This may take a while, please be patient.', '');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing... (Could take several minutes)';
            spinner.style.display = 'block';
            // hideAd(adContainer1); // Optionally hide ads during processing
            // hideAd(adContainer2);

            const formData = new FormData();
            formData.append('audioFile', selectedFile); 

            try {
                const response = await fetch(SERVER_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    let errorMsg = `Server error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) {
                            errorMsg = errorData.error;
                            if (errorData.details) {
                                errorMsg += `\nDetails: ${errorData.details}`;
                            }
                        }
                    } catch (e) {
                        try {
                            const textError = await response.text();
                            if(textError) errorMsg = textError.substring(0,300);
                        } catch (textE) { /* ignore */ }
                    }
                    throw new Error(errorMsg);
                }

                const blob = await response.blob();
                let downloadFilename = "stems.zip";
                const disposition = response.headers.get('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        downloadFilename = matches[1].replace(/['"]/g, '');
                    }
                } else {
                    const originalFilenameBase = selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.')) || 'audio';
                    downloadFilename = `${originalFilenameBase}_stems.zip`;
                }

                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                a.download = downloadFilename;
                document.body.appendChild(a);
                a.click();

                setStatus(`Stems downloaded as ${downloadFilename}! Check your downloads.`, 'success');
                
                setTimeout(() => {
                    if (downloadUrl) window.URL.revokeObjectURL(downloadUrl);
                    if (a && a.parentElement) a.remove();
                }, 3000);

                // Show ads again after successful processing
                // You can decide your strategy here, e.g., only show one, or refresh them.
                showAd(adContainer1, adSlot1HTML); 
                // showAd(adContainer2, adSlot2HTML);
                
            } catch (error) {
                console.error('Separation error:', error);
                setStatus(`Error: ${error.message}`, 'error');
                // Optionally show ads on error too
                // showAd(adContainer1, adSlot1HTML);
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Separate Stems';
                spinner.style.display = 'none';
                audioFileInput.value = null;
                selectedFile = null;
                fileNameDisplay.textContent = 'No file selected';
                processBtn.disabled = true;
            }
        }

        function setStatus(message, type = '') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            if (type) {
                statusMessage.classList.add(type);
            }
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusMessage.textContent === message) {
                         statusMessage.textContent = '';
                         statusMessage.className = 'status-message';
                    }
                }, 10000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            processBtn.disabled = true;
            // Show ads when the page first loads
            showAd(adContainer1, adSlot1HTML);
            showAd(adContainer2, adSlot2HTML);
        });

    </script>
</body>
</html>
