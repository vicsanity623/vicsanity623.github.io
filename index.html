<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5972331036113330"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Audio Stem Separator (Demucs)</title>
    <style>
        :root {
            --primary-bg: #1e1e2f;
            --secondary-bg: #27293d;
            --accent-color: #00bcd4;
            --text-color: #f8f8f2;
            --input-bg: #44475a;
            --success-color: #50fa7b;
            --error-color: #ff5555;
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-color); overscroll-behavior-y: contain; }
        .app-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; padding: 20px; text-align: center; }
        .title { font-size: 2.5em; margin-bottom: 30px; color: var(--accent-color); font-weight: 300; }
        .upload-group { width: 100%; max-width: 500px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .file-input-label { display: inline-block; padding: 12px 20px; font-size: 1em; font-weight: bold; color: var(--text-color); background-color: var(--input-bg); border: 1px dashed var(--accent-color); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease; margin-bottom: 15px; }
        .file-input-label:hover { background-color: #5a5d74; border-color: #00acc1; }
        #audioFile { display: none; }
        #fileNameDisplay { font-size: 0.9em; color: #bd93f9; min-height: 1.2em; margin-bottom: 15px; word-break: break-all; }
        .action-button { padding: 15px 30px; font-size: 1.1em; font-weight: bold; color: var(--text-color); background-color: var(--accent-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; outline: none; width: 100%; max-width: 500px; }
        .action-button:hover { background-color: #00acc1; }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #6272a4; cursor: not-allowed; }
        .status-message { margin-top: 20px; font-size: 0.9em; min-height: 1.2em; color: var(--text-color); white-space: pre-wrap; }
        .status-message.success { color: var(--success-color); }
        .status-message.error { color: var(--error-color); }
        .spinner { display: none; border: 4px solid rgba(248, 248, 242, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .progress-bar-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--input-bg);
            border-radius: var(--border-radius);
            margin-top: 20px;
            height: 20px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-color);
            border-radius: var(--border-radius);
            transition: width 0.5s ease-out;
            text-align: center;
            line-height: 20px;
            color: var(--primary-bg);
            font-weight: bold;
        }
        .progress-percentage {
            font-size: 0.9em;
            color: var(--text-color);
            margin-top: 5px;
        }

        .log-console-container {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--input-bg);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: left;
        }
        .log-console {
            height: 150px;
            overflow-y: auto;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.85em;
            color: #c5c8c6;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-console .log-info { color: #81a2be; }
        .log-console .log-success { color: var(--success-color); }
        .log-console .log-error { color: var(--error-color); }
        .log-console .log-warning { color: #f0c674; }

        footer {
            background-color: var(--secondary-bg);
            padding: 20px;
            text-align: center;
            border-top: 1px solid var(--input-bg);
            margin-top: 40px;
            font-size: 14px;
            color: var(--text-color);
        }
        footer a {
            color: var(--accent-color);
            text-decoration: none;
            margin: 0 10px;
        }
        footer a:hover {
            text-decoration: underline;
        }
        footer div {
            margin-top: 10px;
        }
        footer .copyright-text, footer .disclaimer-text {
            color: #bd93f9;
        }
        footer .disclaimer-text {
            font-size: 12px;
        }
        .visitor-counter-container {
            margin-bottom: 15px;
        }
    </style>
    <meta name="google-site-verification" content="mxPAv2VJ1TR5Heht38zsEerPZyIJltVRLFiN1zyfjJY" />
</head>
<body>
    <div class="app-container">
        <h1 class="title">Audio Stem Separator</h1>
        <div class="upload-group">
            <label for="audioFile" class="file-input-label">Choose Audio File (e.g., MP3, WAV, FLAC)</label>
            <input type="file" id="audioFile" name="audioFile" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac">
            <p id="fileNameDisplay">No file selected</p>
        </div>
        <button id="processBtn" class="action-button" disabled>Separate Stems</button>

        <div id="progressBarContainer" class="progress-bar-container" style="display: none;">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <p id="progressPercentage" class="progress-percentage" style="display: none;">0%</p>

        <div id="logConsoleContainer" class="log-console-container" style="display: none;">
            <pre id="logConsole" class="log-console"></pre>
        </div>

        <div id="spinner" class="spinner"></div>
        <p id="statusMessage" class="status-message"></p>
    </div>

    <script>
        const audioFileInput = document.getElementById('audioFile');
        const processBtn = document.getElementById('processBtn');
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercentageText = document.getElementById('progressPercentage');
        const logConsoleContainer = document.getElementById('logConsoleContainer');
        const logConsole = document.getElementById('logConsole');

        const YOUR_DDNS_HOSTNAME = 'vicsanitymp3.servemp3.com';
        const SERVER_ENDPOINT_BASE = `https://${YOUR_DDNS_HOSTNAME}`;
        const SERVER_ENDPOINT = `${SERVER_ENDPOINT_BASE}/separate-stems`;
        let selectedFile = null;
        let progressInterval = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.classList.add(`log-${type}`);
            logEntry.textContent = `[${timestamp}] ${message}`;
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function updateProgress(percentage) {
            percentage = Math.min(100, Math.max(0, percentage));
            progressBar.style.width = `${percentage}%`;
            progressPercentageText.textContent = `${Math.round(percentage)}%`;
        }

        function resetProcessingUI() {
            progressBarContainer.style.display = 'none';
            progressPercentageText.style.display = 'none';
            logConsoleContainer.style.display = 'none';
            logConsole.innerHTML = '';
            updateProgress(0);
            if (progressInterval) clearInterval(progressInterval);
            processBtn.disabled = false;
            processBtn.textContent = 'Separate Stems';
            spinner.style.display = 'none';
            audioFileInput.value = null;
            selectedFile = null;
            fileNameDisplay.textContent = 'No file selected';
            processBtn.disabled = true;
        }


        audioFileInput.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                fileNameDisplay.textContent = selectedFile.name;
                processBtn.disabled = false;
                processBtn.textContent = 'Separate Stems';
                setStatus('');
                addLog(`File selected: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`);
            } else {
                fileNameDisplay.textContent = 'No file selected';
                processBtn.disabled = true;
                processBtn.textContent = 'Separate Stems';
            }
            progressBarContainer.style.display = 'none';
            progressPercentageText.style.display = 'none';
            logConsoleContainer.style.display = 'none';
            updateProgress(0);
            if(progressInterval) clearInterval(progressInterval);
        });

        processBtn.addEventListener('click', handleSeparation);

        async function handleSeparation() {
            if (!selectedFile) {
                setStatus('Please select an audio file first.', 'error');
                addLog('Process attempt failed: No file selected.', 'error');
                return;
            }
            const MAX_FRONTEND_SIZE_MB = 100;
            if (selectedFile.size > MAX_FRONTEND_SIZE_MB * 1024 * 1024) {
                setStatus(`File is too large (max ${MAX_FRONTEND_SIZE_MB}MB).`, 'error');
                addLog(`File too large: ${(selectedFile.size / 1024 / 1024).toFixed(2)}MB. Max is ${MAX_FRONTEND_SIZE_MB}MB.`, 'error');
                return;
            }

            logConsole.innerHTML = '';
            progressBarContainer.style.display = 'block';
            progressPercentageText.style.display = 'block';
            logConsoleContainer.style.display = 'block';
            updateProgress(0);
            progressBar.style.backgroundColor = 'var(--accent-color)';

            setStatus('Starting process...', '');
            addLog('Process initiated by user.', 'info');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';
            spinner.style.display = 'block';

            const formData = new FormData();
            formData.append('audioFile', selectedFile);

            addLog(`Uploading file "${selectedFile.name}"...`);
            updateProgress(5);

            let currentProgress = 10;
            const targetProgress = 90;
            const estimatedDurationSeconds = 9 * 60;
            const increments = (targetProgress - currentProgress);
            const intervalTime = (estimatedDurationSeconds / increments) * 1000;

            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                currentProgress++;
                if (currentProgress <= targetProgress) {
                    updateProgress(currentProgress);
                    if (currentProgress % 15 === 0 && currentProgress < targetProgress) {
                        addLog(`Server processing audio... (simulated stage ${currentProgress}%)`);
                    }
                } else {
                    clearInterval(progressInterval);
                }
            }, intervalTime);
            updateProgress(10);

            try {
                addLog('Waiting for server response...');
                const response = await fetch(SERVER_ENDPOINT, { method: 'POST', body: formData });

                clearInterval(progressInterval);
                updateProgress(90);

                if (!response.ok) {
                    let errorMsg = `Server error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) { errorMsg = errorData.error; if (errorData.details) { errorMsg += `\nDetails: ${errorData.details}`; } }
                    } catch (e) { try { const textError = await response.text(); if(textError) errorMsg = textError.substring(0,300); } catch (textE) {} }
                    addLog(`Server responded with error: ${errorMsg}`, 'error');
                    updateProgress(90);
                    progressBar.style.backgroundColor = 'var(--error-color)';
                    throw new Error(errorMsg);
                }
                addLog('Server processing complete. Receiving file...', 'success');
                updateProgress(95);

                const blob = await response.blob();
                let downloadFilename = "stems.zip";
                const disposition = response.headers.get('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) { downloadFilename = matches[1].replace(/['"]/g, ''); }
                } else {
                    const originalFilenameBase = selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.')) || 'audio';
                    downloadFilename = `${originalFilenameBase}_stems.zip`;
                }
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = downloadUrl; a.download = downloadFilename;
                document.body.appendChild(a); a.click();

                addLog(`Download started: ${downloadFilename}`, 'success');
                updateProgress(100);
                setStatus(`Stems downloaded as ${downloadFilename}! Check your downloads.`, 'success');

                setTimeout(() => {
                    if (downloadUrl) window.URL.revokeObjectURL(downloadUrl);
                    if (a && a.parentElement) a.remove();
                }, 3000);

            } catch (error) {
                console.error('Separation error:', error);
                setStatus(`Error: ${error.message}`, 'error');
                addLog(`Operation failed: ${error.message}`, 'error');
                if (progressInterval) clearInterval(progressInterval);
                if(progressBar.style.backgroundColor !== 'var(--error-color)') {
                    updateProgress(90); // Keep progress if error occurred after some server work
                    progressBar.style.backgroundColor = 'var(--error-color)';
                }
            } finally {
                if (progressInterval) clearInterval(progressInterval);

                processBtn.disabled = false;
                processBtn.textContent = 'Separate Stems';
                spinner.style.display = 'none';

                setTimeout(() => {
                    if (statusMessage.classList.contains('success')) {
                         progressBarContainer.style.display = 'none';
                         progressPercentageText.style.display = 'none';
                         updateProgress(0);
                         progressBar.style.backgroundColor = 'var(--accent-color)';
                    } else {
                        progressBar.style.backgroundColor = 'var(--accent-color)';
                    }
                    audioFileInput.value = null;
                    selectedFile = null;
                    fileNameDisplay.textContent = 'No file selected';
                    processBtn.disabled = true;
                }, 5000);
            }
        }

        function setStatus(message, type = '') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            if (type) { statusMessage.classList.add(type); }
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusMessage.textContent === message) {
                         statusMessage.textContent = '';
                         statusMessage.className = 'status-message';
                    }
                }, 10000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            processBtn.disabled = true;
            progressBarContainer.style.display = 'none';
            progressPercentageText.style.display = 'none';
            logConsoleContainer.style.display = 'none';
        });
    </script>

    <footer>
        <div>
            <a href="/privacy-policy.html">Privacy Policy</a> |
            <a href="/terms-of-service.html">Terms of Service</a> |
            <a href="https://github.com/vicsanity623/vicsanity623.github.io">GitHub Repository</a>
        </div>

        <div class="visitor-counter-container">
            <a href="https://www.hitwebcounter.com" target="_blank">
            <img src="https://hitwebcounter.com/counter/counter.php?page=20795911&style=0009&nbdigits=6&type=ip&initCount=109" title="Counter Widget" Alt="Visit counter For Websites"   border="0" /></a>
        </div>

        <div class="copyright-text">
            © 2025 Audio Stem Separator. Uses <a href="https://github.com/facebookresearch/demucs">Demucs</a> under MIT License.
        </div>
        <div class="disclaimer-text">
            Do not upload copyrighted material. You must own all processed content.
        </div>
    </footer>
</body>
</html>
