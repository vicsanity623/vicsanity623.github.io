<script>
    const audioFileInput = document.getElementById('audioFile');
    const processBtn = document.getElementById('processBtn');
    const statusMessage = document.getElementById('statusMessage');
    const spinner = document.getElementById('spinner');
    const fileNameDisplay = document.getElementById('fileNameDisplay');

    // --- CORRECTED CONFIGURATION FOR CADDY (HTTPS) ---
    const YOUR_DDNS_HOSTNAME = 'vicsanitymp3.servemp3.com'; // Your DDNS hostname

    // SERVER_ENDPOINT_BASE should now use HTTPS and no explicit port (port 443 is default for HTTPS)
    const SERVER_ENDPOINT_BASE = `https://${YOUR_DDNS_HOSTNAME}`;
    const SERVER_ENDPOINT = `${SERVER_ENDPOINT_BASE}/separate-stems`;
    // --- END CORRECTED CONFIGURATION ---

    let selectedFile = null;

    // --- File Input Handling ---
    audioFileInput.addEventListener('change', (event) => {
        selectedFile = event.target.files[0];
        if (selectedFile) {
            fileNameDisplay.textContent = selectedFile.name;
            processBtn.disabled = false;
            processBtn.textContent = 'Separate Stems';
            setStatus(''); // Clear previous status
        } else {
            fileNameDisplay.textContent = 'No file selected';
            processBtn.disabled = true;
            processBtn.textContent = 'Separate Stems';
        }
    });

    // --- Process Button Click ---
    processBtn.addEventListener('click', handleSeparation);

    async function handleSeparation() {
        if (!selectedFile) {
            setStatus('Please select an audio file first.', 'error');
            return;
        }

        const MAX_FRONTEND_SIZE_MB = 100;
        if (selectedFile.size > MAX_FRONTEND_SIZE_MB * 1024 * 1024) {
            setStatus(`File is too large (max ${MAX_FRONTEND_SIZE_MB}MB).`, 'error');
            return;
        }

        setStatus('Uploading and processing... This may take a while, please be patient.', '');
        processBtn.disabled = true;
        processBtn.textContent = 'Processing... (Could take several minutes)';
        spinner.style.display = 'block';

        const formData = new FormData();
        formData.append('audioFile', selectedFile); 

        try {
            const response = await fetch(SERVER_ENDPOINT, { // SERVER_ENDPOINT now uses HTTPS
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                let errorMsg = `Server error: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.error) {
                        errorMsg = errorData.error;
                        if (errorData.details) {
                            errorMsg += `\nDetails: ${errorData.details}`;
                        }
                    }
                } catch (e) {
                    try {
                        const textError = await response.text();
                        if(textError) errorMsg = textError.substring(0,300);
                    } catch (textE) { /* ignore */ }
                }
                throw new Error(errorMsg);
            }

            const blob = await response.blob();
            let downloadFilename = "stems.zip";
            const disposition = response.headers.get('Content-Disposition');
            if (disposition && disposition.indexOf('attachment') !== -1) {
                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                const matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    downloadFilename = matches[1].replace(/['"]/g, '');
                }
            } else {
                const originalFilenameBase = selectedFile.name.substring(0, selectedFile.name.lastIndexOf('.')) || 'audio';
                downloadFilename = `${originalFilenameBase}_stems.zip`;
            }

            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;
            a.download = downloadFilename;
            document.body.appendChild(a);
            a.click();

            setStatus(`Stems downloaded as ${downloadFilename}! Check your downloads.`, 'success');
            
            setTimeout(() => {
                if (downloadUrl) window.URL.revokeObjectURL(downloadUrl);
                if (a && a.parentElement) a.remove();
            }, 3000);
            
        } catch (error) {
            console.error('Separation error:', error);
            setStatus(`Error: ${error.message}`, 'error');
        } finally {
            processBtn.disabled = false;
            processBtn.textContent = 'Separate Stems';
            spinner.style.display = 'none';

            audioFileInput.value = null;
            selectedFile = null;
            fileNameDisplay.textContent = 'No file selected';
            processBtn.disabled = true;
        }
    }

    function setStatus(message, type = '') {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message';
        if (type) {
            statusMessage.classList.add(type);
        }
        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                if (statusMessage.textContent === message) {
                     statusMessage.textContent = '';
                     statusMessage.className = 'status-message';
                }
            }, 10000);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        processBtn.disabled = true;
    });

</script>
