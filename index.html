<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5972331036113330"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Separate audio files into instrumental stems (vocals, drums, bass, other) using our free online Demucs-powered tool. Upload MP3, WAV, FLAC, and more.">
    <meta name="keywords" content="audio stem separation, demucs, music separation, isolate vocals, remove drums, instrumental maker, karaoke maker, audio tool, vicsanity">
    <title>Free Audio Stem Separator - Powered by Demucs</title>
    <!-- SCRIPT FOR GOOGLE SIGN-IN -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- META TAG FOR GOOGLE CLIENT ID -->
    <meta name="google-client-id" content="50272459426-g5p1du9rh5soq5s9dll3cbtc4v3u4333.apps.googleusercontent.com">
    <style>
        :root {
            --primary-bg: #1e1e2f;
            --secondary-bg: #27293d;
            --accent-color: #00bcd4;
            --text-color: #f8f8f2;
            --input-bg: #44475a;
            --success-color: #50fa7b;
            --error-color: #ff5555;
            --border-radius: 8px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--font-family); 
            background-color: var(--primary-bg); 
            color: var(--text-color); 
            overscroll-behavior-y: contain; 
            line-height: 1.6;
        }
        .main-content-wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .user-status-header {
            display: none;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .user-status-header span {
            margin-right: 15px;
        }
        .user-status-header a, .user-status-header button {
            color: var(--accent-color);
            text-decoration: none;
            background: none;
            border: 1px solid var(--accent-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-left: 10px;
            transition: background-color 0.2s, color 0.2s;
        }
        .user-status-header a:hover, .user-status-header button:hover {
            background-color: var(--accent-color);
            color: var(--primary-bg);
        }
        .app-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 40px 20px;
            text-align: center; 
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            margin-bottom: 40px;
        }
        .title { font-size: 2.5em; margin-bottom: 10px; color: var(--accent-color); font-weight: 300; }
        .subtitle { font-size: 1.1em; margin-bottom: 30px; color: #bd93f9; max-width: 600px; margin-left: auto; margin-right: auto;}
        .upload-group { width: 100%; max-width: 500px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .file-input-label { display: inline-block; padding: 12px 20px; font-size: 1em; font-weight: bold; color: var(--text-color); background-color: var(--input-bg); border: 1px dashed var(--accent-color); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease; margin-bottom: 15px; }
        .file-input-label:hover { background-color: #5a5d74; border-color: #00acc1; }
        #audioFile { display: none; }
        #fileNameDisplay { font-size: 0.9em; color: #bd93f9; min-height: 1.2em; margin-bottom: 15px; word-break: break-all; }
        .filename-tip {
            font-size: 0.8em;
            color: #bd93f9; 
            margin-top: 10px;
            max-width: 480px; 
            line-height: 1.4;
        }
        #auth-options {
            display: none;
            width: 100%;
            max-width: 500px;
            background-color: var(--input-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        #auth-options h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-weight: 400;
        }
        .auth-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #gsi-container {
            display: flex;
            justify-content: center;
        }
        .guest-option button {
            width: 100%;
            padding: 12px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border: 1px solid #6272a4;
            cursor: pointer;
        }
        .guest-option button:hover {
            border-color: var(--accent-color);
        }
        .option-divider {
            text-align: center;
            color: #6272a4;
            margin: 15px 0;
            position: relative;
        }
        .option-divider::before, .option-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: #6272a4;
        }
        .option-divider::before { left: 0; }
        .option-divider::after { right: 0; }
        .action-button { padding: 15px 30px; font-size: 1.1em; font-weight: bold; color: var(--text-color); background-color: var(--accent-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; outline: none; width: 100%; max-width: 500px; }
        .action-button:hover { background-color: #00acc1; }
        .action-button:active { transform: scale(0.98); }
        .action-button:disabled { background-color: #6272a4; cursor: not-allowed; }
        .status-message { margin-top: 20px; font-size: 0.9em; min-height: 1.2em; color: var(--text-color); white-space: pre-wrap; }
        .status-message.success { color: var(--success-color); }
        .status-message.error { color: var(--error-color); }
        .spinner { display: none; border: 4px solid rgba(248, 248, 242, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--input-bg);
            border-radius: var(--border-radius);
            margin-top: 20px;
            height: 20px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-color);
            border-radius: var(--border-radius);
            transition: width 0.5s ease-out;
            text-align: center;
            line-height: 20px;
            color: var(--primary-bg);
            font-weight: bold;
        }
        .progress-percentage {
            font-size: 0.9em;
            color: var(--text-color);
            margin-top: 5px;
        }
        .log-console-container {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--input-bg);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: left;
        }
        .log-console {
            height: 150px;
            overflow-y: auto;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.85em;
            color: #c5c8c6;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-console .log-info { color: #81a2be; }
        .log-console .log-success { color: var(--success-color); }
        .log-console .log-error { color: var(--error-color); }
        .log-console .log-warning { color: #f0c674; }
        #preview-section {
            text-align: center;
            display: none;
        }
        .preview-player-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }
        #previewPlayer {
            width: 100%;
            max-width: 600px;
            border-radius: var(--border-radius);
            outline: none;
        }
        .gallery-link-container {
            margin-top: 20px;
        }
        .gallery-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--input-bg);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .gallery-link:hover {
            background-color: var(--accent-color);
            color: var(--primary-bg);
        }
        .content-section {
            text-align: left;
            margin-bottom: 40px;
            padding: 20px;
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
        }
        .content-section h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 400;
            border-bottom: 1px solid var(--input-bg);
            padding-bottom: 10px;
        }
        .content-section h3 {
            color: #bd93f9;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.4em;
            font-weight: 400;
        }
        .content-section p, .content-section ul, .content-section ol {
            margin-bottom: 15px;
            color: var(--text-color);
        }
        .content-section ul, .content-section ol {
            list-style-position: outside;
            padding-left: 20px;
        }
        .content-section li {
            margin-bottom: 8px;
        }
        .content-section a {
            color: var(--accent-color);
            text-decoration: none;
        }
        .content-section a:hover {
            text-decoration: underline;
        }
        .content-section code {
            background-color: var(--input-bg);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
        }
        .image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 500px;
            min-height: 200px;
            margin: 20px auto;
            background-color: var(--input-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .image-container img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: calc(var(--border-radius) - 4px);
        }
        footer {
            background-color: var(--secondary-bg);
            padding: 20px;
            text-align: center;
            border-top: 1px solid var(--input-bg);
            margin-top: 40px;
            font-size: 14px;
            color: var(--text-color);
        }
        footer a {
            color: var(--accent-color);
            text-decoration: none;
            margin: 0 10px;
        }
        footer a:hover {
            text-decoration: underline;
        }
        footer div {
            margin-top: 10px;
        }
        footer .copyright-text, footer .disclaimer-text {
            color: #bd93f9;
        }
        footer .disclaimer-text {
            font-size: 12px;
        }
        .visitor-counter-container {
            margin-bottom: 15px;
        }
    </style>
    <meta name="google-site-verification" content="mxPAv2VJ1TR5Heht38zsEerPZyIJltVRLFiN1zyfjJY" />
</head>
<body>
    <div class="main-content-wrapper">
        
        <!-- REQUIRED HTML ELEMENT for signed-in user status -->
        <div id="userStatusHeader" class="user-status-header">
            <span id="welcomeMessage"></span>
            <a href="account.html" id="myFilesLink">My Files</a>
            <button id="signOutBtn">Sign Out</button>
        </div>

        <section class="content-section" id="preview-section">
            <h2>Latest Result Preview</h2>
            <p>Listen to a 30-second preview of the vocal stem from the most recently processed song. This demonstrates the quality of the separation.</p>
            <div class="preview-player-container">
                <audio id="previewPlayer" controls src=""></audio>
            </div>
            <div class="gallery-link-container">
                <a href="ideas.html" class="gallery-link">Explore the Ideas Gallery →</a>
            </div>
        </section>

        <div class="app-container">
            <h1 class="title">Online Audio Stem Separator</h1>
            <p class="subtitle">Easily isolate vocals, drums, bass, and other instruments from your audio tracks using the power of Demucs, completely free.</p>

            <div class="upload-group">
                <label for="audioFile" class="file-input-label">Choose Audio File (MP3, WAV, FLAC, etc.)</label>
                <input type="file" id="audioFile" name="audioFile" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac">
                <p id="fileNameDisplay">No file selected</p>
                <p class="filename-tip"><strong>Tip:</strong> Sign in with Google to save your files to your account. This way, you don't need to keep the page open!</p>
            </div>

            <!-- REQUIRED HTML ELEMENT for the choice between guest and signed-in -->
            <div id="auth-options">
                <h3>How would you like to proceed?</h3>
                <div class="auth-buttons-container">
                    <p style="font-size: 0.9em; margin-bottom: 10px;">Sign in to save results to your account and close this page anytime.</p>
                    <div id="gsi-container"></div>
                    <div class="option-divider">or</div>
                    <div class="guest-option">
                         <p style="font-size: 0.9em; margin-bottom: 10px;">Process as a guest. You must keep this page open to download your file.</p>
                        <button id="processGuestBtn" class="action-button">Process as Guest & Download</button>
                    </div>
                </div>
            </div>

            <!-- This button is now mainly for signed-in users -->
            <button id="processBtn" class="action-button" disabled>Separate Stems</button>

            <div id="progressBarContainer" class="progress-bar-container" style="display: none;">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <p id="progressPercentage" class="progress-percentage" style="display: none;">0%</p>

            <div id="logConsoleContainer" class="log-console-container" style="display: none;">
                <pre id="logConsole" class="log-console"></pre>
            </div>

            <div id="spinner" class="spinner"></div>
            <p id="statusMessage" class="status-message"></p>
        </div>

        <!-- The rest of your informational content sections -->
        <section class="content-section" id="what-is-stem-separation">
             <h2>Unlock Your Audio: What is Stem Separation?</h2>
            <p>Stem separation, also known as music source separation, is the process of isolating individual instrumental and vocal tracks (called "stems") from a mixed audio recording. Imagine having a finished song and being able to extract just the vocals, or only the drum track, or the bassline – that's the magic of stem separation!</p>
            <p>This technology has revolutionized how musicians, producers, DJs, and audio enthusiasts interact with music, opening up a world of creative possibilities.</p>
            <div class="image-container">
                <img src="https://raw.githubusercontent.com/vicsanity623/vicsanity623.github.io/refs/heads/main/Audio%20MIX%20Source.png" alt="Diagram illustrating audio stem separation from a mixed track into vocals, drums, bass, and other instruments.">
            </div>
        </section>
        <section class="content-section" id="about-demucs">
            <h2>Powered by Demucs: State-of-the-Art AI</h2>
            <p>This online tool utilizes <strong>Demucs</strong>, a cutting-edge deep learning model for music source separation developed by Meta AI (formerly Facebook Research). Demucs is renowned for its high-quality separation capabilities, leveraging advanced neural network architectures trained on vast amounts of music data.</p>
            <p>Key features of Demucs include:</p>
            <ul>
                <li><strong>High Fidelity:</strong> It excels at producing clean stems with minimal artifacts compared to many older methods.</li>
                <li><strong>Multiple Models:</strong> Demucs offers various pre-trained models, each with different characteristics. This service typically uses a hybrid transformer model (like <code>htdemucs_ft</code>) known for its excellent balance of quality and computational efficiency.</li>
                <li><strong>Open Source:</strong> The Demucs project is <a href="https://en.m.wikipedia.org/wiki/Open_source" target="_blank" rel="noopener noreferrer">open-source</a> (learn more about <a href="https://en.m.wikipedia.org/wiki/Open_source" target="_blank" rel="noopener noreferrer">open source software</a>), and the Demucs code itself can be found on <a href="https://github.com/facebookresearch/demucs" target="_blank" rel="noopener noreferrer">GitHub</a>, fostering a community of researchers and developers who contribute to its advancement.</li>
            </ul>
            <p>By using Demucs, this tool aims to provide you with professional-grade stem separation results, accessible directly from your browser.</p>
        </section>
        <section class="content-section" id="how-to-use">
            <h2>How to Use This Stem Separator</h2>
            <p>Getting your audio stems is simple:</p>
            <ol>
                <li><strong>Choose Your Audio File:</strong> Click the "Choose Audio File" button and select an audio file from your device. We support common formats like MP3, WAV, FLAC, M4A, AAC, and OGG. For best results, use a high-quality source file. 
                <li><strong>Upload & Process:</strong> Once a file is selected, the "Separate Stems" button will activate. Click it to upload your file to our server for processing. You'll see a progress bar and log messages updating you on the status.</li>
                <li><strong>Be Patient:</strong> Can take up to 10 minutes to complete one 5 minute song. Stem separation is a computationally intensive task. Depending on the length of your audio file and current server load, processing can take several minutes. Please keep the browser tab open.</li>
                <li><strong>Download Your Stems:</strong> When processing is complete, a download will automatically begin for a ZIP file containing your separated stems (typically vocals, drums, bass, and "other" instruments).</li>
            </ol>
            <p><strong>Supported Stems:</strong> This service typically separates audio into four main stems:</p>
            <ul>
                <li>Vocals</li>
                <li>Drums</li>
                <li>Bass</li>
                <li>Other (includes guitars, keyboards, synths, strings, etc.)</li>
            </ul>
            <div class="image-container">
                <img src="https://raw.githubusercontent.com/vicsanity623/vicsanity623.github.io/refs/heads/main/Audio%20MIX%20Source.png" alt="Visual guide: Step 1 - Upload audio, Step 2 - Process, Step 3 - Download stems.">
            </div>
        </section>
        <!-- ... and so on for the rest of your content sections ... -->
    </div>

    <script>
        // --- Get all the necessary HTML elements ---
        const audioFileInput = document.getElementById('audioFile');
        const processBtn = document.getElementById('processBtn');
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercentageText = document.getElementById('progressPercentage');
        const logConsoleContainer = document.getElementById('logConsoleContainer');
        const logConsole = document.getElementById('logConsole');
        const previewSection = document.getElementById('preview-section');
        const previewPlayer = document.getElementById('previewPlayer');
    
        // NEW: Get the elements for authentication
        const authOptions = document.getElementById('auth-options');
        const processGuestBtn = document.getElementById('processGuestBtn');
        const userStatusHeader = document.getElementById('userStatusHeader');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const signOutBtn = document.getElementById('signOutBtn');
    
        // --- Configuration and State Variables ---
        const YOUR_DDNS_HOSTNAME = 'vicsanitymp3.servemp3.com';
        const SERVER_ENDPOINT_BASE = `https://${YOUR_DDNS_HOSTNAME}`;
        const SERVER_ENDPOINT = `${SERVER_ENDPOINT_BASE}/separate-stems`;
        const PREVIEW_ENDPOINT = `${SERVER_ENDPOINT_BASE}/api/latest-preview`;
    
        let selectedFile = null;
        let currentUserToken = null;
        let currentUserName = null;
        
        // --- Helper Functions ---
        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }
    
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.classList.add(`log-${type}`);
            logEntry.textContent = `[${timestamp}] ${message}`;
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }
    
        function updateProgress(percentage) {
            percentage = Math.min(100, Math.max(0, percentage));
            progressBar.style.width = `${percentage}%`;
            progressPercentageText.textContent = `${Math.round(percentage)}%`;
        }

        function setStatus(message, type = '') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            if (type) statusMessage.classList.add(type);
        }
        
        // --- Core UI Management Functions ---
        function resetUIState() {
            processBtn.style.display = 'block'; // Show the default button
            processBtn.disabled = true;
            processBtn.textContent = 'Separate Stems';
            
            authOptions.style.display = 'none'; // Hide the auth choices
            userStatusHeader.style.display = 'none'; // Hide the user welcome message

            spinner.style.display = 'none';
            progressBarContainer.style.display = 'none';
            progressPercentageText.style.display = 'none';
            logConsoleContainer.style.display = 'none';
            logConsole.innerHTML = '';
            updateProgress(0);
            
            audioFileInput.value = null;
            selectedFile = null;
            fileNameDisplay.textContent = 'No file selected';
            setStatus('');
        }

        function updateUIForLoginState() {
            if (currentUserToken) { // User is LOGGED IN
                userStatusHeader.style.display = 'flex';
                welcomeMessage.textContent = `Welcome, ${currentUserName}!`;
                authOptions.style.display = 'none'; // Hide the choice box

                if(selectedFile) {
                    processBtn.style.display = 'block';
                    processBtn.disabled = false;
                    processBtn.textContent = 'Process & Save to My Account';
                } else {
                    processBtn.style.display = 'block';
                    processBtn.disabled = true;
                    processBtn.textContent = 'Separate Stems';
                }
            } else { // User is a GUEST
                userStatusHeader.style.display = 'none';
                
                if(selectedFile) {
                    processBtn.style.display = 'none'; // Hide the default button
                    authOptions.style.display = 'block'; // Show the guest/signin choice box
                } else {
                    processBtn.style.display = 'block'; // Show the default button
                    processBtn.disabled = true;
                    authOptions.style.display = 'none';
                }
            }
        }
    
        // --- Main Application Logic ---
        async function handleSeparation(isGuest) {
            if (!selectedFile) {
                setStatus('Please select an audio file first.', 'error');
                return;
            }
            
            authOptions.style.display = 'none';
            processBtn.style.display = 'none';
            logConsole.innerHTML = ''; 
            progressBarContainer.style.display = 'block';
            progressPercentageText.style.display = 'block';
            logConsoleContainer.style.display = 'block';
            updateProgress(0);
            setStatus('Starting process...', '');
            spinner.style.display = 'block';
            
            const formData = new FormData();
            formData.append('audioFile', selectedFile);
    
            const fetchOptions = { method: 'POST', body: formData };
            if (!isGuest && currentUserToken) {
                fetchOptions.headers = { 'Authorization': `Bearer ${currentUserToken}` };
            }
            
            addLog(`Uploading and processing file "${selectedFile.name}"...`);
            updateProgress(25);
            
            try {
                const response = await fetch(SERVER_ENDPOINT, fetchOptions);
                updateProgress(50);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Server returned an invalid response.' }));
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
    
                if (isGuest) {
                    addLog('Processing complete. Receiving file...', 'success');
                    updateProgress(95);
                    const blob = await response.blob();
                    let downloadFilename = "stems.zip";
                    const disposition = response.headers.get('Content-Disposition');
                    if (disposition && disposition.includes('attachment')) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches?.[1]) { downloadFilename = matches[1].replace(/['"]/g, ''); }
                    }
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = downloadUrl; a.download = downloadFilename;
                    document.body.appendChild(a); a.click();
                    updateProgress(100);
                    addLog(`Download started for ${downloadFilename}.`, 'success');
                    setStatus('Download complete! Check your downloads folder.', 'success');
                    setTimeout(() => { window.URL.revokeObjectURL(downloadUrl); a.remove(); }, 3000);
                } else {
                    const result = await response.json();
                    updateProgress(100);
                    setStatus(result.message, 'success');
                    addLog(result.message, 'success');
                }
    
            } catch (error) {
                setStatus(`Error: ${error.message}`, 'error');
                addLog(`Operation failed: ${error.message}`, 'error');
                progressBar.style.backgroundColor = 'var(--error-color)';
            } finally {
                spinner.style.display = 'none';
                setTimeout(resetUIState, 8000); 
            }
        }
        
        // --- Google Sign-In Handlers ---
        function handleGoogleCredentialResponse(response) {
            const idToken = response.credential;
            const payload = parseJwt(idToken);
            if (payload) {
                currentUserToken = idToken;
                currentUserName = payload.name;
                updateUIForLoginState(); // <-- Critically update UI after successful sign-in
            }
        }
        
        function handleSignOut() {
            currentUserToken = null;
            currentUserName = null;
            google.accounts.id.disableAutoSelect();
            updateUIForLoginState();
        }
    
        // --- Event Listeners and Initializer ---
        document.addEventListener('DOMContentLoaded', () => {
            resetUIState();
    
            // Initialize Google Sign-In
            const googleClientId = document.querySelector('meta[name="google-client-id"]').content;
            google.accounts.id.initialize({
                client_id: googleClientId,
                callback: handleGoogleCredentialResponse,
                auto_select: true
            });
            google.accounts.id.renderButton(document.getElementById('gsi-container'),
                { theme: 'outline', size: 'large', type: 'standard', text: 'signin_with', width: '300' } 
            );
            google.accounts.id.prompt();
    
            // Wire up all the buttons
            signOutBtn.addEventListener('click', handleSignOut);
            processGuestBtn.addEventListener('click', () => handleSeparation(true)); // Guest separation
            processBtn.addEventListener('click', () => handleSeparation(false)); // Signed-in separation
    
            // The most important event listener for user interaction
            audioFileInput.addEventListener('change', (event) => {
                selectedFile = event.target.files[0];
                if (!selectedFile) {
                    resetUIState();
                    return;
                }
                fileNameDisplay.textContent = selectedFile.name;
                
                // This is the core logic that decides what the user sees next
                updateUIForLoginState();
                
                // UX Improvement: If user is not logged in, give them another chance with the pop-up
                if (!currentUserToken) {
                    google.accounts.id.prompt();
                }
            });
    
            // Fetch the preview track
            async function fetchAndSetPreview() {
                try {
                    const response = await fetch(PREVIEW_ENDPOINT);
                    if (!response.ok) return;
                    const data = await response.json();
                    if (data.url) {
                        previewPlayer.src = `${SERVER_ENDPOINT_BASE}${data.url}`;
                        previewSection.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Could not fetch preview:', error);
                }
            }
            fetchAndSetPreview();
    
            if (previewPlayer) {
                previewPlayer.addEventListener('timeupdate', function() { if (this.currentTime >= 30) { this.pause(); this.currentTime = 30; } });
            }
        });
    </script>
    
    <footer>
        <div>
            <a href="/privacy-policy.html">Privacy Policy</a> |
            <a href="/terms-of-service.html">Terms of Service</a> |
            <a href="https://github.com/vicsanity623/vicsanity623.github.io">GitHub Repository</a> |
            <a href="rpg.html">Play Tap Guardian RPG</a>
        </div>
        <div class="visitor-counter-container">
            <a href="https://www.hitwebcounter.com" target="_blank">
            <img src="https://hitwebcounter.com/counter/counter.php?page=20795911&style=0009&nbdigits=6&type=ip&initCount=109" title="Counter Widget" Alt="Visit counter For Websites"   border="0" /></a>
        </div>
        <div class="copyright-text">
            © 2025 Audio Stem Separator. This service uses <a href="https://github.com/facebookresearch/demucs" target="_blank" rel="noopener noreferrer">Demucs</a>, an open-source project by Meta AI, under the MIT License.
        </div>
        <div class="disclaimer-text">
            Please do not upload copyrighted material unless you own the rights or have explicit permission. Users are solely responsible for the content they process.
        </div>
    </footer>
</body>
</html>
